<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>综合医学知识检索系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            background: #f8f9fa;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .header-section {
            background: var(--primary-gradient);
            padding: 30px 0 50px;
            color: white;
        }

        .nav-category {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin: -40px auto 20px;
            max-width: 750px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            position: relative;
            z-index: 10;
        }

        .category-btn {
            flex: 1;
            padding: 18px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .category-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .category-btn i {
            font-size: 1.8rem;
            display: block;
            margin-bottom: 6px;
        }

        .category-btn .title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .category-btn .desc {
            font-size: 0.7rem;
            color: #666;
            margin-top: 3px;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .search-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin-bottom: 20px;
        }

        .source-checkbox {
            display: inline-flex;
            align-items: center;
            padding: 10px 16px;
            border-radius: 10px;
            margin: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #e0e0e0;
            background: white;
        }

        .source-checkbox:hover {
            border-color: #999;
        }

        .source-checkbox.checked {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .source-checkbox input {
            display: none;
        }

        .source-checkbox i {
            margin-right: 6px;
        }

        .source-checkbox.europepmc i {
            color: #2e7d32;
        }

        .source-checkbox.pubmed i {
            color: #1565c0;
        }

        .source-checkbox.plos i {
            color: #7b1fa2;
        }

        .source-checkbox.openfda i {
            color: #e65100;
        }

        .source-checkbox.rxnorm i {
            color: #00838f;
        }

        .journal-section {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 10px;
        }

        .journal-section.show {
            display: block;
        }

        .journal-dropdown {
            position: absolute;
            width: 100%;
            max-height: 350px;
            overflow-y: auto;
            z-index: 2000;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid #ddd;
            background: white;
            display: none;
            border-radius: 10px;
        }

        .journal-dropdown .j-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .journal-dropdown .j-item:hover {
            background: #f5f5f5;
        }

        .stat-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            flex: 1;
            border-radius: 10px;
            padding: 12px;
            color: white;
            text-align: center;
        }

        .stat-box .num {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-box .label {
            font-size: 0.7rem;
            opacity: 0.9;
        }

        .result-card {
            background: white;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .result-card:hover {
            transform: translateX(4px);
        }

        .result-card.europepmc {
            border-left-color: #2e7d32;
        }

        .result-card.pubmed {
            border-left-color: #1565c0;
        }

        .result-card.plos {
            border-left-color: #7b1fa2;
        }

        .result-card.openfda {
            border-left-color: #e65100;
        }

        .result-card.rxnorm {
            border-left-color: #00838f;
        }

        .result-card.clinicaltrials {
            border-left-color: #c2185b;
        }

        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
            font-weight: 500;
        }

        .nav-tabs .nav-link.active {
            background: white;
            border-bottom-color: white;
        }

        .count-badge {
            background: #667eea;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            z-index: 10;
        }

        .tab-pane {
            position: relative;
            min-height: 100px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .back-btn {
            margin-bottom: 15px;
        }

        /* AI助手样式 */
        .ai-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .ai-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
        }

        .ai-fab .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            font-size: 0.7rem;
        }

        .ai-panel {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 400px;
            max-height: 500px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 999;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .ai-panel.show {
            display: flex;
        }

        .ai-panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ai-panel-header h6 {
            margin: 0;
        }

        .ai-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            max-height: 300px;
            background: #f8f9fa;
        }

        .ai-message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 85%;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .ai-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .ai-message.assistant {
            background: white;
            border: 1px solid #e0e0e0;
        }

        .ai-panel-footer {
            padding: 12px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }

        .ai-input-group {
            display: flex;
            gap: 8px;
        }

        .ai-input-group input {
            flex: 1;
            border-radius: 20px;
            padding: 8px 15px;
            border: 1px solid #ddd;
        }

        .ai-input-group button {
            border-radius: 20px;
            padding: 8px 15px;
        }

        .ai-kb-info {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <div class="header-section">
        <div class="container">
            <h3 class="text-center mb-1"><i class="bi bi-search-heart"></i> 综合医学知识检索系统</h3>
            <p class="text-center mb-0 opacity-75 small">整合多个公开医学数据源</p>
        </div>
    </div>

    <div class="container pb-5">
        <!-- 首页导航 -->
        <div class="nav-category" id="navCategory">
            <div class="d-flex gap-3">
                <div class="category-btn" onclick="showPage('journal')">
                    <i class="bi bi-journal-richtext text-success"></i>
                    <div class="title">期刊文献</div>
                    <div class="desc">Europe PMC / PubMed / PLOS</div>
                </div>
                <div class="category-btn" onclick="showPage('drug')">
                    <i class="bi bi-capsule text-warning"></i>
                    <div class="title">药品信息</div>
                    <div class="desc">openFDA / RxNorm</div>
                </div>
                <div class="category-btn" onclick="showPage('trial')">
                    <i class="bi bi-clipboard2-pulse text-primary"></i>
                    <div class="title">临床试验</div>
                    <div class="desc">ClinicalTrials.gov</div>
                </div>
            </div>
        </div>

        <!-- ==================== 期刊文献页面 ==================== -->
        <div class="page-section" id="page-journal">
            <button class="btn btn-outline-secondary back-btn" onclick="showHome()"><i class="bi bi-arrow-left"></i>
                返回</button>

            <div class="search-card">
                <h4 class="mb-4"><i class="bi bi-journal-richtext text-success"></i> 期刊文献检索</h4>

                <form id="journalForm">
                    <!-- 数据源多选 -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">1. 选择数据源（可多选）</label>
                        <div id="journalSources">
                            <label class="source-checkbox europepmc checked">
                                <input type="checkbox" value="europepmc" checked onchange="onJournalSourceChange()">
                                <i class="bi bi-book"></i> Europe PMC
                                <small class="text-success ms-1">(支持期刊+OA)</small>
                            </label>
                            <label class="source-checkbox pubmed">
                                <input type="checkbox" value="pubmed" onchange="onJournalSourceChange()">
                                <i class="bi bi-journal-medical"></i> PubMed
                            </label>
                            <label class="source-checkbox plos">
                                <input type="checkbox" value="plos" onchange="onJournalSourceChange()">
                                <i class="bi bi-file-text"></i> PLOS
                                <small class="text-info ms-1">(全OA)</small>
                            </label>
                        </div>
                    </div>

                    <!-- 期刊联想区域 - 仅Europe PMC -->
                    <div class="journal-section show" id="journalSection">
                        <h6 class="mb-2"><i class="bi bi-book text-success"></i> Europe PMC 期刊筛选</h6>
                        <div class="row g-3">
                            <div class="col-md-6 position-relative" id="journalWrapper">
                                <label class="form-label">期刊名称（支持联想，36000+期刊）</label>
                                <input type="text" id="journalInput" class="form-control" placeholder="输入2个字符开始..."
                                    autocomplete="off">
                                <input type="hidden" id="selectedIssn">
                                <div id="journalDropdown" class="journal-dropdown"></div>
                                <small class="text-muted" id="journalStatus">加载中...</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">年份范围</label>
                                <div class="input-group">
                                    <input type="number" id="euroStartYear" class="form-control" value="2020">
                                    <span class="input-group-text">-</span>
                                    <input type="number" id="euroEndYear" class="form-control" value="2026">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">筛选</label>
                                <div class="form-check"><input class="form-check-input" type="checkbox"
                                        id="filterOA"><label class="form-check-label" for="filterOA">仅OA</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox"
                                        id="filterFT"><label class="form-check-label" for="filterFT">仅全文</label></div>
                            </div>
                        </div>
                    </div>

                    <!-- 通用关键词 -->
                    <div class="mt-3">
                        <label class="form-label fw-bold">2. 检索关键词 <small class="text-muted fw-normal">(Europe
                                PMC选择期刊后可选)</small></label>
                        <input type="text" id="journalKeyword" class="form-control form-control-lg"
                            placeholder="输入疾病、症状、治疗方法...">
                    </div>

                    <button type="submit" class="btn btn-success btn-lg w-100 mt-4" id="journalSearchBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="journalSpinner"></span>
                        <i class="bi bi-search"></i> 开始检索
                    </button>
                </form>

                <!-- Europe PMC 统计 -->
                <div id="euroStats" class="stat-row d-none">
                    <div class="stat-box" style="background:#4e73df;">
                        <div class="num" id="statTotal">0</div>
                        <div class="label">总文献</div>
                    </div>
                    <div class="stat-box" style="background:#1cc88a;">
                        <div class="num" id="statOA">0</div>
                        <div class="label">Open Access</div>
                    </div>
                    <div class="stat-box" style="background:#36b9cc;">
                        <div class="num" id="statFT">0</div>
                        <div class="label">全文可用</div>
                    </div>
                </div>
            </div>

            <div id="journalResults" class="d-none">
                <ul class="nav nav-tabs" id="journalTabs"></ul>
                <div class="tab-content bg-light p-3 rounded-bottom" id="journalTabContent"></div>
            </div>
        </div>

        <!-- ==================== 药品信息页面 ==================== -->
        <div class="page-section" id="page-drug">
            <button class="btn btn-outline-secondary back-btn" onclick="showHome()"><i class="bi bi-arrow-left"></i>
                返回</button>

            <div class="search-card">
                <h4 class="mb-4"><i class="bi bi-capsule text-warning"></i> 药品信息检索</h4>

                <form id="drugForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">1. 选择数据源（可多选）</label>
                        <div id="drugSources">
                            <label class="source-checkbox openfda checked">
                                <input type="checkbox" value="openfda" checked>
                                <i class="bi bi-capsule"></i> openFDA
                                <small class="text-muted ms-1">(FDA药品标签)</small>
                            </label>
                            <label class="source-checkbox rxnorm checked">
                                <input type="checkbox" value="rxnorm" checked>
                                <i class="bi bi-prescription2"></i> RxNorm
                                <small class="text-muted ms-1">(药物命名)</small>
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">2. 药品名称 / 适应症</label>
                        <input type="text" id="drugQuery" class="form-control form-control-lg"
                            placeholder="例如: aspirin, diabetes, headache..." required>
                    </div>

                    <button type="submit" class="btn btn-warning btn-lg w-100" id="drugSearchBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="drugSpinner"></span>
                        <i class="bi bi-search"></i> 检索药品
                    </button>
                </form>
            </div>

            <div id="drugResults" class="d-none">
                <ul class="nav nav-tabs" id="drugTabs"></ul>
                <div class="tab-content bg-light p-3 rounded-bottom" id="drugTabContent"></div>
            </div>
        </div>

        <!-- ==================== 临床试验页面 ==================== -->
        <div class="page-section" id="page-trial">
            <button class="btn btn-outline-secondary back-btn" onclick="showHome()"><i class="bi bi-arrow-left"></i>
                返回</button>

            <div class="search-card">
                <h4 class="mb-4"><i class="bi bi-clipboard2-pulse text-primary"></i> 临床试验检索</h4>

                <form id="trialForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">疾病 / 药物 / 干预措施</label>
                        <input type="text" id="trialQuery" class="form-control form-control-lg"
                            placeholder="例如: cancer, COVID-19, diabetes..." required>
                    </div>
                    <div class="alert alert-info small">
                        <i class="bi bi-info-circle"></i> 数据来源：ClinicalTrials.gov (NIH)。ChiCTR暂无公开API，请访问 <a
                            href="https://www.chictr.org.cn" target="_blank">chictr.org.cn</a>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg w-100" id="trialSearchBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="trialSpinner"></span>
                        <i class="bi bi-search"></i> 检索
                    </button>
                </form>
            </div>

            <div id="trialResults" class="d-none">
                <div class="results-container" id="trialResultsList"></div>
            </div>
        </div>

        <div id="errorAlert" class="alert alert-danger d-none mt-3"></div>
    </div>

    <!-- AI助手按钮 -->
    <button class="ai-fab" id="aiFab" onclick="toggleAIPanel()">
        <i class="bi bi-robot"></i>
        <span class="badge" id="kbBadge" style="display:none;">0</span>
    </button>

    <!-- AI对话面板 -->
    <div class="ai-panel" id="aiPanel">
        <div class="ai-panel-header">
            <h6><i class="bi bi-robot"></i> AI医学助手</h6>
            <div>
                <select id="modelSelect" class="form-select form-select-sm"
                    style="width:auto;display:inline-block;font-size:0.75rem;">
                    <option value="gemini-3-pro-preview-thinking">Gemini 3 Pro</option>
                    <option value="gpt-5.2">GPT-5.2</option>
                    <option value="claude-opus-4-5-20251101-thinking">Claude Opus 4.5</option>
                    <option value="doubao-seed-1-8-251215">Doubao Seed</option>
                    <option value="DeepSeek-V3.2-Thinking">DeepSeek V3.2</option>
                </select>
                <button class="btn btn-sm btn-light ms-2" onclick="toggleAIPanel()"><i class="bi bi-x"></i></button>
            </div>
        </div>
        <div class="ai-panel-body" id="aiMessages">
            <div class="ai-message assistant">
                <i class="bi bi-lightbulb"></i> 您好！我是AI医学助手。请先检索文献，我将基于检索结果回答您的问题。
            </div>
        </div>
        <div class="ai-panel-footer">
            <div class="ai-kb-info" id="kbInfo">知识库: 暂无内容，请先检索</div>
            <div class="ai-input-group">
                <input type="text" id="aiInput" placeholder="输入您的问题..."
                    onkeypress="if(event.key==='Enter')sendAIMessage()">
                <button class="btn btn-primary" onclick="sendAIMessage()" id="aiSendBtn">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==================== 页面切换 ====================
        function showPage(page) {
            document.getElementById('navCategory').style.display = 'none';
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.add('active');
        }
        function showHome() {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById('navCategory').style.display = 'block';
        }

        // 数据源复选框样式 - 使用input的change事件
        document.querySelectorAll('.source-checkbox input').forEach(cb => {
            cb.addEventListener('change', () => {
                const label = cb.closest('.source-checkbox');
                label.classList.toggle('checked', cb.checked);
                // 如果是期刊来源，更新期刊区域显示
                if (cb.closest('#journalSources')) {
                    onJournalSourceChange();
                }
            });
        });

        // 期刊数据源变化时显示/隐藏期刊区域
        function onJournalSourceChange() {
            const sources = getSelectedSources('journalSources');
            const onlyEuropePMC = sources.length === 1 && sources[0] === 'europepmc';
            document.getElementById('journalSection').classList.toggle('show', onlyEuropePMC);
        }

        function getSelectedSources(containerId) {
            return Array.from(document.querySelectorAll(`#${containerId} input:checked`)).map(el => el.value);
        }

        // ==================== 期刊列表加载 ====================
        let ALL_JOURNALS = [];
        let journalsLoading = false;

        // 使用fetch加载期刊
        async function loadJournals() {
            if (journalsLoading) return;
            journalsLoading = true;

            const statusEl = document.getElementById('journalStatus');
            statusEl.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 正在加载期刊列表(4.5MB)...';
            statusEl.className = 'text-muted';

            try {
                // 检查是否从 http 协议访问
                if (location.protocol === 'file:') {
                    throw new Error('请通过 http://localhost:8080 访问页面，不能直接打开HTML文件');
                }

                const response = await fetch('journals.json', {
                    cache: 'force-cache'  // 使用缓存
                });
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                ALL_JOURNALS = await response.json();
                statusEl.textContent = `✓ 已加载 ${ALL_JOURNALS.length.toLocaleString()} 个期刊`;
                statusEl.className = 'text-success';
                console.log('期刊加载成功:', ALL_JOURNALS.length);
            } catch (e) {
                console.error('期刊加载失败:', e);
                statusEl.innerHTML = `<span class="text-danger">期刊加载失败: ${e.message}</span> <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadJournals()">重试</button>`;

                // 如果本地服务未启动，提示用户
                if (e.message.includes('Failed to fetch')) {
                    statusEl.innerHTML += '<br><small class="text-muted">提示: 确保通过 http://localhost:8080 访问，而不是直接打开HTML文件</small>';
                }
            } finally {
                journalsLoading = false;
            }
        }

        // 进入期刊页面时加载
        const originalShowPage = showPage;
        showPage = function (page) {
            originalShowPage(page);
            if (page === 'journal' && ALL_JOURNALS.length === 0) {
                loadJournals();
            }
        };

        // 页面加载后延迟加载
        setTimeout(loadJournals, 500);

        // 期刊联想
        const jInput = document.getElementById('journalInput');
        const jDropdown = document.getElementById('journalDropdown');
        const jIssn = document.getElementById('selectedIssn');

        let debounceTimer;
        jInput.addEventListener('input', e => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const v = e.target.value.trim().toLowerCase();
                if (v.length < 2) { jDropdown.style.display = 'none'; return; }

                if (ALL_JOURNALS.length === 0) {
                    jDropdown.innerHTML = '<div class="j-item text-warning">期刊列表未加载，请刷新页面</div>';
                    jDropdown.style.display = 'block';
                    return;
                }

                const matched = ALL_JOURNALS.filter(j =>
                    j.title.toLowerCase().includes(v) ||
                    j.abbr.toLowerCase().includes(v) ||
                    j.issn.includes(v)
                ).slice(0, 30);

                if (matched.length) {
                    jDropdown.innerHTML = matched.map(j =>
                        `<div class="j-item" onclick="selectJournal('${j.title.replace(/'/g, "\\'")}','${j.issn}')">
                            <strong>${j.title}</strong><br>
                            <small class="text-muted">ISSN: ${j.issn} | ${j.abbr}</small>
                        </div>`
                    ).join('');
                } else {
                    jDropdown.innerHTML = '<div class="j-item text-muted">未找到匹配的期刊</div>';
                }
                jDropdown.style.display = 'block';
            }, 150);
        });

        function selectJournal(title, issn) {
            jInput.value = title;
            jIssn.value = issn;
            jDropdown.style.display = 'none';
        }

        document.addEventListener('click', e => {
            if (!document.getElementById('journalWrapper').contains(e.target)) {
                jDropdown.style.display = 'none';
            }
        });

        // ==================== 期刊检索 ====================
        document.getElementById('journalForm').addEventListener('submit', async e => {
            e.preventDefault();
            const sources = getSelectedSources('journalSources');
            if (!sources.length) { showError('请选择至少一个数据源'); return; }

            const keyword = document.getElementById('journalKeyword').value.trim();
            const jName = jInput.value.trim();
            const issn = jIssn.value;
            const onlyEuropePMC = sources.length === 1 && sources[0] === 'europepmc';

            // 验证：必须有关键词，或者（仅Europe PMC时有期刊名/ISSN）
            if (!keyword && !(onlyEuropePMC && (jName || issn))) {
                showError('请输入关键词' + (onlyEuropePMC ? '或选择期刊' : ''));
                return;
            }

            setLoading('journal', true); hideError();

            // Europe PMC 特殊处理
            let euroQuery = keyword || '*';
            if (onlyEuropePMC) {
                const sYear = document.getElementById('euroStartYear').value;
                const eYear = document.getElementById('euroEndYear').value;
                const filterOA = document.getElementById('filterOA').checked;
                const filterFT = document.getElementById('filterFT').checked;

                let qParts = [];
                if (issn) qParts.push(`ISSN:"${issn}"`);
                else if (jName) qParts.push(`JOURNAL:"${jName}"`);
                if (keyword) qParts.push(keyword);
                if (sYear && eYear) qParts.push(`(PUB_YEAR:[${sYear} TO ${eYear}])`);
                if (filterOA) qParts.push(`(OPEN_ACCESS:Y)`);
                if (filterFT) qParts.push(`(HAS_FT:Y)`);
                euroQuery = qParts.join(' AND ');

                // 统计
                try {
                    const BASE = "https://www.ebi.ac.uk/europepmc/webservices/rest";
                    const [r1, r2, r3] = await Promise.all([
                        fetch(`${BASE}/search?query=${encodeURIComponent(euroQuery)}&pageSize=1&format=json`),
                        fetch(`${BASE}/search?query=${encodeURIComponent(euroQuery.replace(/ AND \(OPEN_ACCESS:Y\)/g, '') + ' AND (OPEN_ACCESS:Y)')}&pageSize=1&format=json`),
                        fetch(`${BASE}/search?query=${encodeURIComponent(euroQuery.replace(/ AND \(HAS_FT:Y\)/g, '') + ' AND (HAS_FT:Y)')}&pageSize=1&format=json`)
                    ]);
                    const [d1, d2, d3] = await Promise.all([r1.json(), r2.json(), r3.json()]);
                    document.getElementById('euroStats').classList.remove('d-none');
                    document.getElementById('statTotal').textContent = (d1.hitCount || 0).toLocaleString();
                    document.getElementById('statOA').textContent = (d2.hitCount || 0).toLocaleString();
                    document.getElementById('statFT').textContent = (d3.hitCount || 0).toLocaleString();
                } catch (e) { console.error('统计失败', e); }
            } else {
                document.getElementById('euroStats').classList.add('d-none');
            }

            // 创建标签页
            createTabs('journal', sources);

            // 并行请求
            const requests = sources.map(async src => {
                showTabLoading('journal', src);
                try {
                    const data = await fetchJournalData(src, src === 'europepmc' ? euroQuery : keyword);
                    renderTabResults('journal', src, data);
                } catch (err) {
                    renderTabError('journal', src, err.message);
                }
            });

            await Promise.all(requests);
            document.getElementById('journalResults').classList.remove('d-none');
            setLoading('journal', false);
        });

        async function fetchJournalData(src, query) {
            let url, data;
            switch (src) {
                case 'europepmc':
                    const res1 = await fetch(`https://www.ebi.ac.uk/europepmc/webservices/rest/search?query=${encodeURIComponent(query)}&pageSize=25&format=json&resultType=lite`);
                    data = await res1.json();
                    return { count: data.hitCount || 0, items: (data.resultList?.result || []).map(a => ({ src: 'europepmc', title: a.title, authors: a.authorString, journal: a.journalTitle, year: a.pubYear, isOA: a.isOpenAccess === 'Y', hasFT: a.inEPMC === 'Y', link: a.doi ? `https://doi.org/${a.doi}` : `https://europepmc.org/article/MED/${a.pmid}` })) };
                case 'pubmed':
                    const res2a = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encodeURIComponent(query)}&retmode=json&retmax=25`);
                    const d2a = await res2a.json();
                    const ids = d2a.esearchresult?.idlist || [];
                    if (!ids.length) return { count: 0, items: [] };
                    const res2b = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=${ids.join(',')}&retmode=json`);
                    const d2b = await res2b.json();
                    return { count: parseInt(d2a.esearchresult?.count || 0), items: ids.map(id => { const a = d2b.result?.[id]; return a ? { src: 'pubmed', title: a.title, authors: a.authors?.map(x => x.name).join(', '), journal: a.source, year: a.pubdate?.split(' ')[0], pmid: id, link: `https://pubmed.ncbi.nlm.nih.gov/${id}/` } : null; }).filter(Boolean) };
                case 'plos':
                    const res3 = await fetch(`https://api.plos.org/search?q=${encodeURIComponent(query)}&wt=json&rows=25&fl=id,title,author,journal,publication_date,abstract`);
                    data = await res3.json();
                    return { count: data.response?.numFound || 0, items: (data.response?.docs || []).map(a => { let abs = Array.isArray(a.abstract) ? a.abstract[0] : (a.abstract || ''); return { src: 'plos', title: a.title, authors: Array.isArray(a.author) ? a.author.join(', ') : '', journal: a.journal, abstract: abs.substring(0, 100), link: `https://doi.org/${a.id}`, isOA: true, hasFT: true }; }) };
            }
        }

        // ==================== 药品检索 ====================
        document.getElementById('drugForm').addEventListener('submit', async e => {
            e.preventDefault();
            const sources = getSelectedSources('drugSources');
            if (!sources.length) { showError('请选择至少一个数据源'); return; }
            const query = document.getElementById('drugQuery').value.trim();
            if (!query) return;

            setLoading('drug', true); hideError();
            createTabs('drug', sources);

            const requests = sources.map(async src => {
                showTabLoading('drug', src);
                try {
                    const data = await fetchDrugData(src, query);
                    renderTabResults('drug', src, data);
                } catch (err) {
                    renderTabError('drug', src, err.message);
                }
            });

            await Promise.all(requests);
            document.getElementById('drugResults').classList.remove('d-none');
            setLoading('drug', false);
        });

        async function fetchDrugData(src, query) {
            switch (src) {
                case 'openfda':
                    const res1 = await fetch(`https://api.fda.gov/drug/label.json?search=${encodeURIComponent(query)}&limit=25`);
                    const d1 = await res1.json();
                    return { count: d1.meta?.results?.total || 0, items: (d1.results || []).map(a => ({ src: 'openfda', title: a.openfda?.brand_name?.[0] || a.openfda?.generic_name?.[0] || '未知', generic: a.openfda?.generic_name?.[0] || '', manufacturer: a.openfda?.manufacturer_name?.[0] || '', indication: (a.indications_and_usage?.[0] || '').substring(0, 120), route: a.openfda?.route?.[0] || '', link: a.openfda?.spl_id?.[0] ? `https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${a.openfda.spl_id[0]}` : '#' })) };
                case 'rxnorm':
                    const res2 = await fetch(`https://rxnav.nlm.nih.gov/REST/drugs.json?name=${encodeURIComponent(query)}`);
                    const d2 = await res2.json();
                    const items = []; (d2.drugGroup?.conceptGroup || []).forEach(g => (g.conceptProperties || []).forEach(p => items.push({ src: 'rxnorm', name: p.name, rxcui: p.rxcui, tty: p.tty, link: `https://mor.nlm.nih.gov/RxNav/search?searchBy=RXCUI&searchTerm=${p.rxcui}` })));
                    return { count: items.length, items };
            }
        }

        // ==================== 临床试验检索 ====================
        document.getElementById('trialForm').addEventListener('submit', async e => {
            e.preventDefault();
            const query = document.getElementById('trialQuery').value.trim();
            if (!query) return;

            setLoading('trial', true); hideError();

            try {
                const res = await fetch(`https://clinicaltrials.gov/api/v2/studies?query.term=${encodeURIComponent(query)}&pageSize=25`);
                const data = await res.json();
                const count = data.totalCount || 0;
                const items = (data.studies || []).map(s => ({ title: s.protocolSection?.identificationModule?.officialTitle || s.protocolSection?.identificationModule?.briefTitle, nctId: s.protocolSection?.identificationModule?.nctId, status: s.protocolSection?.statusModule?.overallStatus, phase: s.protocolSection?.designModule?.phases?.join(', '), conditions: s.protocolSection?.conditionsModule?.conditions?.join(', '), link: `https://clinicaltrials.gov/study/${s.protocolSection?.identificationModule?.nctId}` }));

                document.getElementById('trialResults').classList.remove('d-none');
                const list = document.getElementById('trialResultsList');
                if (items.length === 0) {
                    list.innerHTML = '<div class="empty-state">无结果</div>';
                } else {
                    list.innerHTML = `<h5 class="mb-3">ClinicalTrials.gov 结果 <span class="badge bg-primary">${count.toLocaleString()}</span></h5>` + items.map(i => `<div class="result-card clinicaltrials"><h6><a href="${i.link}" target="_blank">${i.title}</a></h6><div class="small text-muted">${i.conditions}</div><div class="mt-1"><span class="badge bg-primary">${i.nctId}</span> <span class="badge bg-info">${i.status}</span> <span class="badge bg-secondary">${i.phase || 'N/A'}</span></div></div>`).join('');
                }
            } catch (err) {
                showError('ClinicalTrials.gov 请求失败: ' + err.message);
            }
            setLoading('trial', false);
        });

        // ==================== 标签页管理 ====================
        const SOURCE_NAMES = { europepmc: 'Europe PMC', pubmed: 'PubMed', plos: 'PLOS', openfda: 'openFDA', rxnorm: 'RxNorm' };

        function createTabs(page, sources) {
            const tabsEl = document.getElementById(`${page}Tabs`);
            const contentEl = document.getElementById(`${page}TabContent`);
            tabsEl.innerHTML = sources.map((s, i) => `<li class="nav-item"><button class="nav-link ${i === 0 ? 'active' : ''}" data-bs-toggle="tab" data-bs-target="#${page}Tab-${s}">${SOURCE_NAMES[s]} <span class="count-badge" id="${page}Count-${s}">...</span></button></li>`).join('');
            contentEl.innerHTML = sources.map((s, i) => `<div class="tab-pane fade ${i === 0 ? 'show active' : ''}" id="${page}Tab-${s}"></div>`).join('');
        }

        function showTabLoading(page, src) {
            document.getElementById(`${page}Tab-${src}`).innerHTML = '<div class="loading-overlay"><div class="spinner-border text-primary"></div></div>';
        }

        function renderTabResults(page, src, data) {
            document.getElementById(`${page}Count-${src}`).textContent = data.count.toLocaleString();
            const pane = document.getElementById(`${page}Tab-${src}`);
            if (!data.items.length) { pane.innerHTML = '<div class="empty-state">无结果</div>'; return; }
            pane.innerHTML = data.items.map(i => renderCard(src, i)).join('');
        }

        function renderTabError(page, src, msg) {
            document.getElementById(`${page}Count-${src}`).textContent = '!';
            document.getElementById(`${page}Tab-${src}`).innerHTML = `<div class="alert alert-warning">${SOURCE_NAMES[src]} 失败: ${msg}</div>`;
        }

        function renderCard(src, i) {
            const oa = i.isOA ? '<span class="badge bg-success">OA</span>' : '';
            const ft = i.hasFT ? '<span class="badge bg-info">全文</span>' : '';
            switch (src) {
                case 'europepmc': return `<div class="result-card europepmc"><h6><a href="${i.link}" target="_blank">${i.title}</a></h6><div class="text-muted small">${i.authors || ''}</div><div class="mt-1"><span class="badge bg-secondary">${i.journal || ''}</span> <span class="badge bg-light text-dark">${i.year || ''}</span> ${oa} ${ft}</div></div>`;
                case 'pubmed': return `<div class="result-card pubmed"><h6><a href="${i.link}" target="_blank">${i.title}</a></h6><div class="text-muted small">${i.authors || ''}</div><div class="mt-1"><span class="badge bg-secondary">${i.journal || ''}</span> <span class="badge bg-light text-dark">${i.year || ''}</span> <span class="badge bg-primary">PMID:${i.pmid}</span></div></div>`;
                case 'plos': return `<div class="result-card plos"><h6><a href="${i.link}" target="_blank">${i.title}</a></h6><div class="text-muted small">${i.authors || ''}</div><div class="mt-1">${oa} ${ft} <span class="badge bg-secondary">${i.journal || ''}</span></div></div>`;
                case 'openfda': return `<div class="result-card openfda"><h6><a href="${i.link}" target="_blank">${i.title}</a></h6><div class="small text-muted">通用名: ${i.generic} | 厂商: ${i.manufacturer}</div><div class="small mt-1">${i.indication}...</div><span class="badge bg-warning text-dark">${i.route}</span></div>`;
                case 'rxnorm': return `<div class="result-card rxnorm"><h6><a href="${i.link}" target="_blank">${i.name}</a></h6><div class="mt-1"><span class="badge bg-success">RxCUI: ${i.rxcui}</span> <span class="badge bg-secondary">${i.tty}</span></div></div>`;
            }
        }

        // ==================== 工具函数 ====================
        function setLoading(id, b) {
            const btn = document.getElementById(`${id}SearchBtn`);
            const spinner = document.getElementById(`${id}Spinner`);
            if (btn) btn.disabled = b;
            if (spinner) spinner.classList.toggle('d-none', !b);
        }
        function showError(m) { const e = document.getElementById('errorAlert'); e.textContent = m; e.classList.remove('d-none'); }
        function hideError() { document.getElementById('errorAlert').classList.add('d-none'); }

        // ==================== AI 问答功能 ====================
        const AI_CONFIG = {
            baseUrl: 'https://www.dmxapi.cn/v1',
            apiKey: 'sk-ANZikovLXwI5QG7w8yHVAisdGeugkfGyq7W1I9ZIavPBhRQs'
        };

        let knowledgeBase = [];  // 存储检索结果
        let chatHistory = [];    // 对话历史

        // 切换AI面板
        function toggleAIPanel() {
            document.getElementById('aiPanel').classList.toggle('show');
        }

        // 更新知识库（每次检索后调用）
        function updateKnowledgeBase(source, items) {
            // 移除该来源的旧数据
            knowledgeBase = knowledgeBase.filter(k => k.source !== source);
            // 添加新数据
            items.forEach(item => {
                knowledgeBase.push({
                    source: source,
                    title: item.title || item.name || '',
                    content: item.authors || item.indication || item.conditions || '',
                    journal: item.journal || '',
                    year: item.year || '',
                    link: item.link || ''
                });
            });
            // 更新UI
            updateKBInfo();
        }

        function updateKBInfo() {
            const count = knowledgeBase.length;
            document.getElementById('kbInfo').textContent = `知识库: ${count} 条记录`;
            const badge = document.getElementById('kbBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // 发送AI消息
        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const question = input.value.trim();
            if (!question) return;

            if (knowledgeBase.length === 0) {
                addMessage('assistant', '请先使用上方的检索功能搜索文献，我将基于检索结果回答您的问题。');
                return;
            }

            // 添加用户消息
            addMessage('user', question);
            input.value = '';

            // 构建上下文
            const context = knowledgeBase.slice(0, 20).map((k, i) =>
                `[${i + 1}] ${k.title}${k.journal ? ` (${k.journal} ${k.year})` : ''}${k.content ? `: ${k.content.substring(0, 200)}` : ''}`
            ).join('\n');

            const systemPrompt = `你是一位专业的医学知识助手。请基于以下检索到的医学文献信息回答用户问题。回答要简洁专业，如果信息不足请说明。

检索到的相关文献：
${context}`;

            // 显示加载状态
            const loadingId = addMessage('assistant', '<i class="spinner-border spinner-border-sm"></i> 正在思考...');
            const model = document.getElementById('modelSelect').value;

            try {
                const response = await fetch(`${AI_CONFIG.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...chatHistory.slice(-6),  // 保留最近3轮对话
                            { role: 'user', content: question }
                        ],
                        max_tokens: 1000
                    })
                });

                const data = await response.json();
                const answer = data.choices?.[0]?.message?.content || '抱歉，未能获取回答。';

                // 更新消息
                updateMessage(loadingId, answer);

                // 保存到历史
                chatHistory.push({ role: 'user', content: question });
                chatHistory.push({ role: 'assistant', content: answer });
            } catch (err) {
                updateMessage(loadingId, '请求失败: ' + err.message);
            }
        }

        function addMessage(role, content) {
            const msgId = 'msg-' + Date.now();
            const messagesEl = document.getElementById('aiMessages');
            const msgDiv = document.createElement('div');
            msgDiv.id = msgId;
            msgDiv.className = `ai-message ${role}`;
            msgDiv.innerHTML = content;
            messagesEl.appendChild(msgDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            return msgId;
        }

        function updateMessage(msgId, content) {
            const el = document.getElementById(msgId);
            if (el) el.innerHTML = content;
        }

        // 修改原有的renderTabResults函数，添加知识库更新
        const originalRenderTabResults = renderTabResults;
        renderTabResults = function (page, src, data) {
            originalRenderTabResults(page, src, data);
            // 更新知识库
            if (data.items && data.items.length > 0) {
                updateKnowledgeBase(src, data.items);
            }
        };
    </script>
</body>

</html>