<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>综合医学知识检索系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary-color: #1a73e8;
            --text-color: #202124;
            --bg-gray: #f8f9fa;
            --border-color: #dadce0;
        }

        body {
            background: var(--bg-gray);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-color);
        }

        .header-section {
            background: var(--primary-color);
            padding: 24px 0 48px;
            color: white;
        }

        .nav-category {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin: -40px auto 24px;
            max-width: 700px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            position: relative;
            z-index: 10;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .search-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .source-checkbox {
            display: inline-flex;
            align-items: center;
            padding: 8px 14px;
            border-radius: 6px;
            margin: 3px;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid var(--border-color);
            background: white;
            font-size: 0.9rem;
        }

        .source-checkbox:hover {
            border-color: var(--primary-color);
        }

        .source-checkbox.checked {
            border-color: var(--primary-color);
            background: #e8f0fe;
            color: var(--primary-color);
        }

        .source-checkbox input {
            display: none;
        }

        .source-checkbox i {
            margin-right: 6px;
        }

        .source-checkbox.europepmc i {
            color: #2e7d32;
        }

        .source-checkbox.pubmed i {
            color: #1565c0;
        }

        .source-checkbox.plos i {
            color: #7b1fa2;
        }

        .source-checkbox.openfda i {
            color: var(--primary-color);
        }

        .source-checkbox.rxnorm i {
            color: var(--primary-color);
        }

        .journal-section {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .journal-section.show {
            display: block;
        }

        .journal-dropdown {
            position: absolute;
            width: 100%;
            max-height: 350px;
            overflow-y: auto;
            z-index: 2000;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid #ddd;
            background: white;
            display: none;
            border-radius: 10px;
        }

        .journal-dropdown .j-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .journal-dropdown .j-item:hover {
            background: #f5f5f5;
        }

        .stat-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            flex: 1;
            border-radius: 10px;
            padding: 12px;
            color: white;
            text-align: center;
        }

        .stat-box .num {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-box .label {
            font-size: 0.7rem;
            opacity: 0.9;
        }

        .result-card {
            background: white;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .result-card:hover {
            transform: translateX(4px);
        }

        .result-card.europepmc {
            border-left-color: #2e7d32;
        }

        .result-card.pubmed {
            border-left-color: #1565c0;
        }

        .result-card.plos {
            border-left-color: #7b1fa2;
        }

        .result-card.openfda {
            border-left-color: #e65100;
        }

        .result-card.rxnorm {
            border-left-color: #00838f;
        }

        .result-card.clinicaltrials {
            border-left-color: #c2185b;
        }

        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
            font-weight: 500;
        }

        .nav-tabs .nav-link.active {
            background: white;
            border-bottom-color: white;
        }

        .count-badge {
            background: #667eea;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            z-index: 10;
        }

        .tab-pane {
            position: relative;
            min-height: 100px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .back-btn {
            margin-bottom: 15px;
        }

        /* AI助手样式 */
        .ai-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .ai-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
        }

        .ai-fab .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            font-size: 0.7rem;
        }

        .ai-panel {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 400px;
            max-height: 500px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 999;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .ai-panel.show {
            display: flex;
        }

        .ai-panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ai-panel-header h6 {
            margin: 0;
        }

        .ai-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            max-height: 300px;
            background: #f8f9fa;
        }

        .ai-message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 85%;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .ai-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .ai-message.assistant {
            background: white;
            border: 1px solid #e0e0e0;
        }

        .ai-panel-footer {
            padding: 12px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }

        .ai-input-group {
            display: flex;
            gap: 8px;
        }

        .ai-input-group input {
            flex: 1;
            border-radius: 20px;
            padding: 8px 15px;
            border: 1px solid #ddd;
        }

        .ai-input-group button {
            border-radius: 20px;
            padding: 8px 15px;
        }

        .ai-kb-info {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <div class="header-section">
        <div class="container">
            <h3 class="text-center mb-1"><i class="bi bi-search-heart"></i> 综合医学知识检索系统</h3>
            <p class="text-center mb-0 opacity-75 small">整合多个公开医学数据源</p>
        </div>
    </div>

    <div class="container pb-5">
        <!-- 首页导航 -->
        <div class="nav-category" id="navCategory">
            <div class="row g-4">
                <!-- 左侧：AI问答 -->
                <div class="col-md-5">
                    <div class="h-100 p-4 rounded" style="background:var(--primary-color);color:white;cursor:pointer;"
                        onclick="showPage('qa')">
                        <h4 class="mb-3">AI智能问答</h4>
                        <p class="mb-2 opacity-75">RAG检索增强生成</p>
                        <p class="small opacity-50 mb-0">基于多数据源检索，结合大模型生成专业回答</p>
                    </div>
                </div>

                <!-- 右侧：检索功能 -->
                <div class="col-md-7">
                    <div class="mb-2 text-muted small fw-bold">文献与数据检索</div>
                    <div class="d-flex flex-column gap-2">
                        <div class="p-3 border rounded bg-white" style="cursor:pointer;" onclick="showPage('journal')"
                            onmouseover="this.style.borderColor='var(--primary-color)'"
                            onmouseout="this.style.borderColor='var(--border-color)'">
                            <div class="fw-bold">期刊文献</div>
                            <div class="small text-muted">Europe PMC / PubMed / PLOS</div>
                        </div>
                        <div class="p-3 border rounded bg-white" style="cursor:pointer;" onclick="showPage('drug')"
                            onmouseover="this.style.borderColor='var(--primary-color)'"
                            onmouseout="this.style.borderColor='var(--border-color)'">
                            <div class="fw-bold">药品信息</div>
                            <div class="small text-muted">openFDA / RxNorm</div>
                        </div>
                        <div class="p-3 border rounded bg-white" style="cursor:pointer;" onclick="showPage('trial')"
                            onmouseover="this.style.borderColor='var(--primary-color)'"
                            onmouseout="this.style.borderColor='var(--border-color)'">
                            <div class="fw-bold">临床试验</div>
                            <div class="small text-muted">ClinicalTrials.gov</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== 期刊文献页面 ==================== -->
        <div class="page-section" id="page-journal">
            <a href="javascript:showHome()" class="text-muted small mb-2 d-inline-block">&larr; 返回</a>

            <div class="search-card">
                <h5 class="mb-3">期刊文献检索</h5>

                <form id="journalForm">
                    <!-- 数据源多选 -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">1. 选择数据源（可多选）</label>
                        <div id="journalSources">
                            <label class="source-checkbox europepmc checked">
                                <input type="checkbox" value="europepmc" checked onchange="onJournalSourceChange()">
                                <i class="bi bi-book"></i> Europe PMC
                                <small class="text-success ms-1">(支持期刊+OA)</small>
                            </label>
                            <label class="source-checkbox pubmed">
                                <input type="checkbox" value="pubmed" onchange="onJournalSourceChange()">
                                <i class="bi bi-journal-medical"></i> PubMed
                            </label>
                            <label class="source-checkbox plos">
                                <input type="checkbox" value="plos" onchange="onJournalSourceChange()">
                                <i class="bi bi-file-text"></i> PLOS
                                <small class="text-info ms-1">(全OA)</small>
                            </label>
                        </div>
                    </div>

                    <!-- 期刊筛选区域 - 仅Europe PMC (支持多选) -->
                    <div class="journal-section show" id="journalSection">
                        <h6 class="mb-2">Europe PMC 期刊筛选 <small class="text-muted">(可多选)</small></h6>
                        <div class="row g-3">
                            <div class="col-md-6 position-relative" id="journalWrapper">
                                <label class="form-label small">输入期刊名搜索添加</label>
                                <input type="text" id="journalInput" class="form-control" placeholder="输入2个字符开始..."
                                    autocomplete="off">
                                <div id="journalDropdown" class="journal-dropdown"></div>
                                <div id="selectedJournalTags" class="d-flex flex-wrap gap-1 mt-2"></div>
                                <small class="text-muted" id="journalStatus">加载中...</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">年份范围</label>
                                <div class="input-group">
                                    <input type="number" id="euroStartYear" class="form-control" value="2020">
                                    <span class="input-group-text">-</span>
                                    <input type="number" id="euroEndYear" class="form-control" value="2026">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">筛选</label>
                                <div class="form-check"><input class="form-check-input" type="checkbox"
                                        id="filterOA"><label class="form-check-label" for="filterOA">仅OA</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox"
                                        id="filterFT"><label class="form-check-label" for="filterFT">仅全文</label></div>
                            </div>
                        </div>
                    </div>

                    <!-- 检索问题 -->
                    <div class="mt-3">
                        <label class="form-label fw-bold">2. 检索问题 <small
                                class="text-muted fw-normal">(自然语言会自动转为检索式)</small></label>
                        <input type="text" id="journalKeyword" class="form-control form-control-lg"
                            placeholder="输入您的问题，如：糖尿病最新治疗方法">
                    </div>

                    <button type="submit" class="btn w-100 mt-3" style="background:var(--primary-color);color:white"
                        id="journalSearchBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="journalSpinner"></span>
                        开始检索
                    </button>
                </form>

                <!-- Europe PMC 统计 -->
                <div id="euroStats" class="stat-row d-none">
                    <div class="stat-box" style="background:#4e73df;">
                        <div class="num" id="statTotal">0</div>
                        <div class="label">总文献</div>
                    </div>
                    <div class="stat-box" style="background:#1cc88a;">
                        <div class="num" id="statOA">0</div>
                        <div class="label">Open Access</div>
                    </div>
                    <div class="stat-box" style="background:#36b9cc;">
                        <div class="num" id="statFT">0</div>
                        <div class="label">全文可用</div>
                    </div>
                </div>
            </div>

            <div id="journalResults" class="d-none">
                <ul class="nav nav-tabs" id="journalTabs"></ul>
                <div class="tab-content bg-light p-3 rounded-bottom" id="journalTabContent"></div>
            </div>
        </div>

        <!-- ==================== 药品信息页面 ==================== -->
        <div class="page-section" id="page-drug">
            <a href="javascript:showHome()" class="text-muted small mb-2 d-inline-block">&larr; 返回</a>

            <div class="search-card">
                <h5 class="mb-3">药品信息检索</h5>

                <form id="drugForm">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">数据源</label>
                        <div id="drugSources" class="d-flex flex-wrap gap-1">
                            <label class="source-checkbox openfda checked">
                                <input type="checkbox" value="openfda" checked> openFDA
                            </label>
                            <label class="source-checkbox rxnorm checked">
                                <input type="checkbox" value="rxnorm" checked> RxNorm
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">药品名称 / 适应症</label>
                        <input type="text" id="drugQuery" class="form-control" placeholder="例如: aspirin, diabetes..."
                            required>
                    </div>

                    <button type="submit" class="btn w-100" style="background:var(--primary-color);color:white"
                        id="drugSearchBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="drugSpinner"></span>
                        检索药品
                    </button>
                </form>
            </div>

            <div id="drugResults" class="d-none">
                <ul class="nav nav-tabs" id="drugTabs"></ul>
                <div class="tab-content bg-light p-3 rounded-bottom" id="drugTabContent"></div>
            </div>
        </div>

        <!-- ==================== 临床试验页面 ==================== -->
        <div class="page-section" id="page-trial">
            <a href="javascript:showHome()" class="text-muted small mb-2 d-inline-block">&larr; 返回</a>

            <div class="search-card">
                <h5 class="mb-3">临床试验检索</h5>

                <form id="trialForm">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">疾病 / 药物 / 干预措施</label>
                        <input type="text" id="trialQuery" class="form-control" placeholder="例如: cancer, COVID-19..."
                            required>
                    </div>
                    <small class="text-muted d-block mb-3">数据来源：ClinicalTrials.gov (NIH)</small>
                    <button type="submit" class="btn w-100" style="background:var(--primary-color);color:white"
                        id="trialSearchBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="trialSpinner"></span>
                        检索
                    </button>
                </form>
            </div>

            <div id="trialResults" class="d-none">
                <div class="results-container" id="trialResultsList"></div>
            </div>
        </div>

        <!-- ==================== AI智能问答页面 ==================== -->
        <div class="page-section" id="page-qa">
            <a href="javascript:showHome()" class="text-muted small mb-2 d-inline-block">&larr; 返回</a>

            <div class="search-card">
                <h5 class="mb-3">AI医学智能问答</h5>

                <!-- 配置区：一行三列 -->
                <div class="row g-3 mb-3">
                    <!-- 数据源 -->
                    <div class="col-md-5">
                        <label class="form-label small fw-bold">数据源</label>
                        <div id="qaSources" class="d-flex flex-wrap gap-1">
                            <label class="source-checkbox europepmc checked" onchange="toggleQAJournalFilter()">
                                <input type="checkbox" value="europepmc" checked onchange="toggleQAJournalFilter()">
                                Europe PMC
                            </label>
                            <label class="source-checkbox pubmed checked">
                                <input type="checkbox" value="pubmed" checked> PubMed
                            </label>
                            <label class="source-checkbox plos">
                                <input type="checkbox" value="plos"> PLOS
                            </label>
                            <label class="source-checkbox openfda">
                                <input type="checkbox" value="openfda"> openFDA
                            </label>
                        </div>
                    </div>
                    <!-- 期刊筛选 -->
                    <div class="col-md-4" id="qaJournalFilter" style="display:none;">
                        <label class="form-label small fw-bold">期刊筛选 <span
                                class="fw-normal text-muted">(可选)</span></label>
                        <input type="text" id="qaJournalInput" class="form-control form-control-sm"
                            placeholder="输入期刊名..." autocomplete="off">
                        <div id="qaJournalDropdown" class="journal-dropdown"></div>
                        <div id="qaSelectedJournals" class="d-flex flex-wrap gap-1 mt-1"></div>
                    </div>
                    <!-- 模型多选 -->
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">模型 <span
                                class="text-muted fw-normal">(可多选)</span></label>
                        <div id="qaModelSelect" class="d-flex flex-column gap-1" style="font-size:0.85rem;">
                            <label><input type="checkbox" value="gemini-3-pro-preview-thinking" checked> Gemini 3
                                Pro</label>
                            <label><input type="checkbox" value="gpt-5.2"> GPT 5.2</label>
                            <label><input type="checkbox" value="claude-opus-4-5-20251101-thinking"> Claude Opus
                                4.5</label>
                            <label><input type="checkbox" value="doubao-seed-1-8-251215"> Doubao Seed</label>
                            <label><input type="checkbox" value="DeepSeek-V3.2-Thinking"> DeepSeek V3.2</label>
                        </div>
                    </div>
                </div>

                <!-- 问题输入 -->
                <div class="mb-3">
                    <label class="form-label small fw-bold">问题</label>
                    <textarea id="qaQuestion" class="form-control" rows="2" placeholder="例如：糖尿病的最新治疗方法有哪些？"></textarea>
                </div>

                <!-- 直接问答选项 -->
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="qaDirectMode">
                    <label class="form-check-label small" for="qaDirectMode">
                        直接问答 <span class="text-muted">(不检索文献，直接使用AI知识回答)</span>
                    </label>
                </div>

                <button class="btn w-100" style="background:var(--primary-color);color:white;" id="qaSearchBtn"
                    onclick="startRAGQuery()">
                    <span class="spinner-border spinner-border-sm d-none" id="qaSpinner"></span>
                    开始问答
                </button>
            </div>

            <!-- 处理状态与详情 -->
            <div id="qaStatus" class="d-none mt-3">
                <div class="search-card">
                    <h6>处理进度</h6>
                    <div class="progress mb-2" style="height: 6px;">
                        <div class="progress-bar" id="qaProgress" style="width: 0%;background:var(--primary-color);">
                        </div>
                    </div>
                    <div id="qaStatusText" class="small text-muted mb-3">准备中...</div>

                    <!-- 详细过程（折叠） -->
                    <div class="accordion" id="qaDetailsAccordion">
                        <div class="accordion-item border-0">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed p-2 small" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#qaDetailsBody"
                                    style="background:#f8f9fa;">
                                    查看详细处理过程
                                </button>
                            </h2>
                            <div id="qaDetailsBody" class="accordion-collapse collapse">
                                <div class="accordion-body p-2 small" style="background:#f8f9fa;">
                                    <!-- 步骤1 -->
                                    <div class="mb-3 pb-2 border-bottom">
                                        <div class="fw-bold mb-1">1. AI生成检索式</div>
                                        <code id="qaDetailQuery" class="d-block p-2 bg-white rounded">-</code>
                                    </div>
                                    <!-- 步骤2 -->
                                    <div class="mb-3 pb-2 border-bottom">
                                        <div class="fw-bold mb-1">2. 检索结果 <span class="badge bg-secondary"
                                                id="qaDetailSearchCount">0</span></div>
                                        <div id="qaDetailSearchResults" class="bg-white p-2 rounded"
                                            style="max-height:300px;overflow-y:auto;">-</div>
                                    </div>
                                    <!-- 步骤3 -->
                                    <div class="mb-3 pb-2 border-bottom">
                                        <div class="fw-bold mb-1">3. 文本分片 <span class="badge bg-secondary"
                                                id="qaDetailChunkCount">0</span></div>
                                        <div id="qaDetailChunks" class="bg-white p-2 rounded"
                                            style="max-height:300px;overflow-y:auto;">-</div>
                                    </div>
                                    <!-- 步骤4 -->
                                    <div class="mb-3 pb-2 border-bottom">
                                        <div class="fw-bold mb-1">4. 向量相似度排序Top-30</div>
                                        <div id="qaDetailSimilar" class="bg-white p-2 rounded"
                                            style="max-height:300px;overflow-y:auto;">-</div>
                                    </div>
                                    <!-- 步骤5 -->
                                    <div class="mb-2">
                                        <div class="fw-bold mb-1">5. Rerank重排序Top-10</div>
                                        <div id="qaDetailRerank" class="bg-white p-2 rounded"
                                            style="max-height:300px;overflow-y:auto;">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 回答区域 -->
            <div id="qaAnswer" class="d-none mt-3">
                <div class="search-card">
                    <h5 class="mb-3">AI回答</h5>
                    <!-- 多模型回答容器 -->
                    <div id="qaAnswerContent" style="font-size:0.9rem;line-height:1.7;"></div>

                    <!-- 参考文献 -->
                    <div id="qaReferences" class="mt-4">
                        <h6>参考文献</h6>
                        <div id="qaRefList" class="small"></div>
                    </div>

                    <!-- 继续提问 -->
                    <div class="mt-4 pt-3 border-top">
                        <label class="form-label small text-muted">继续提问（基于当前上下文）</label>
                        <div class="d-flex gap-2">
                            <input type="text" id="qaFollowUp" class="form-control" placeholder="输入追问..."
                                onkeypress="if(event.key==='Enter')askFollowUp()">
                            <button class="btn btn-primary" onclick="askFollowUp()">发送</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="errorAlert" class="alert alert-danger d-none mt-3"></div>
    </div>

    <!-- AI助手按钮 -->
    <button class="ai-fab" id="aiFab" onclick="toggleAIPanel()">
        <i class="bi bi-robot"></i>
        <span class="badge" id="kbBadge" style="display:none;">0</span>
    </button>

    <!-- AI对话面板 -->
    <div class="ai-panel" id="aiPanel">
        <div class="ai-panel-header">
            <h6><i class="bi bi-robot"></i> AI医学助手</h6>
            <div>
                <select id="modelSelect" class="form-select form-select-sm"
                    style="width:auto;display:inline-block;font-size:0.75rem;">
                    <option value="gemini-3-pro-preview-thinking">Gemini 3 Pro</option>
                    <option value="gpt-5.2">GPT-5.2</option>
                    <option value="claude-opus-4-5-20251101-thinking">Claude Opus 4.5</option>
                    <option value="doubao-seed-1-8-251215">Doubao Seed</option>
                    <option value="DeepSeek-V3.2-Thinking">DeepSeek V3.2</option>
                </select>
                <button class="btn btn-sm btn-light ms-2" onclick="toggleAIPanel()"><i class="bi bi-x"></i></button>
            </div>
        </div>
        <div class="ai-panel-body" id="aiMessages">
            <div class="ai-message assistant">
                <i class="bi bi-lightbulb"></i> 您好！我是AI医学助手。请先检索文献，我将基于检索结果回答您的问题。
            </div>
        </div>
        <div class="ai-panel-footer">
            <div class="ai-kb-info" id="kbInfo">知识库: 暂无内容，请先检索</div>
            <div class="ai-input-group">
                <input type="text" id="aiInput" placeholder="输入您的问题..."
                    onkeypress="if(event.key==='Enter')sendAIMessage()">
                <button class="btn btn-primary" onclick="sendAIMessage()" id="aiSendBtn">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==================== 页面切换 ====================
        function showPage(page) {
            document.getElementById('navCategory').style.display = 'none';
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.add('active');
        }
        function showHome() {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById('navCategory').style.display = 'block';
        }

        // 数据源复选框样式 - 使用input的change事件
        document.querySelectorAll('.source-checkbox input').forEach(cb => {
            cb.addEventListener('change', () => {
                const label = cb.closest('.source-checkbox');
                label.classList.toggle('checked', cb.checked);
                // 如果是期刊来源，更新期刊区域显示
                if (cb.closest('#journalSources')) {
                    onJournalSourceChange();
                }
            });
        });

        // 期刊数据源变化时显示/隐藏期刊区域
        function onJournalSourceChange() {
            const sources = getSelectedSources('journalSources');
            const onlyEuropePMC = sources.length === 1 && sources[0] === 'europepmc';
            document.getElementById('journalSection').classList.toggle('show', onlyEuropePMC);
        }

        function getSelectedSources(containerId) {
            return Array.from(document.querySelectorAll(`#${containerId} input:checked`)).map(el => el.value);
        }

        // ==================== 期刊列表加载 ====================
        let ALL_JOURNALS = [];
        let journalsLoading = false;

        // 使用fetch加载期刊
        async function loadJournals() {
            if (journalsLoading) return;
            journalsLoading = true;

            const statusEl = document.getElementById('journalStatus');
            statusEl.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 正在加载期刊列表(4.5MB)...';
            statusEl.className = 'text-muted';

            try {
                // 检查是否从 http 协议访问
                if (location.protocol === 'file:') {
                    throw new Error('请通过 http://localhost:8080 访问页面，不能直接打开HTML文件');
                }

                const response = await fetch('journals.json', {
                    cache: 'force-cache'  // 使用缓存
                });
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                ALL_JOURNALS = await response.json();
                statusEl.textContent = `✓ 已加载 ${ALL_JOURNALS.length.toLocaleString()} 个期刊`;
                statusEl.className = 'text-success';
                console.log('期刊加载成功:', ALL_JOURNALS.length);
            } catch (e) {
                console.error('期刊加载失败:', e);
                statusEl.innerHTML = `<span class="text-danger">期刊加载失败: ${e.message}</span> <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadJournals()">重试</button>`;

                // 如果本地服务未启动，提示用户
                if (e.message.includes('Failed to fetch')) {
                    statusEl.innerHTML += '<br><small class="text-muted">提示: 确保通过 http://localhost:8080 访问，而不是直接打开HTML文件</small>';
                }
            } finally {
                journalsLoading = false;
            }
        }

        // 进入期刊页面时加载
        const originalShowPage = showPage;
        showPage = function (page) {
            originalShowPage(page);
            if (page === 'journal' && ALL_JOURNALS.length === 0) {
                loadJournals();
            }
        };

        // 页面加载后延迟加载
        setTimeout(loadJournals, 500);

        // 期刊联想
        const jInput = document.getElementById('journalInput');
        const jDropdown = document.getElementById('journalDropdown');

        let debounceTimer;
        jInput.addEventListener('input', e => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const v = e.target.value.trim().toLowerCase();
                if (v.length < 2) { jDropdown.style.display = 'none'; return; }

                if (ALL_JOURNALS.length === 0) {
                    jDropdown.innerHTML = '<div class="j-item text-warning">期刊列表未加载，请刷新页面</div>';
                    jDropdown.style.display = 'block';
                    return;
                }

                const matched = ALL_JOURNALS.filter(j =>
                    j.title.toLowerCase().includes(v) ||
                    j.abbr.toLowerCase().includes(v) ||
                    j.issn.includes(v)
                ).slice(0, 30);

                if (matched.length) {
                    jDropdown.innerHTML = matched.map(j =>
                        `<div class="j-item" onclick="selectJournal('${j.title.replace(/'/g, "\\'")}','${j.issn}')">
                            <strong>${j.title}</strong><br>
                            <small class="text-muted">ISSN: ${j.issn} | ${j.abbr}</small>
                        </div>`
                    ).join('');
                } else {
                    jDropdown.innerHTML = '<div class="j-item text-muted">未找到匹配的期刊</div>';
                }
                jDropdown.style.display = 'block';
            }, 150);
        });

        // 期刊多选
        let selectedJournals = [];

        function selectJournal(title, issn) {
            if (selectedJournals.some(j => j.issn === issn)) return;
            selectedJournals.push({ title, issn });
            renderJournalTags();
            jInput.value = '';
            jDropdown.style.display = 'none';
        }

        function removeJournal(issn) {
            selectedJournals = selectedJournals.filter(j => j.issn !== issn);
            renderJournalTags();
        }

        function renderJournalTags() {
            const container = document.getElementById('selectedJournalTags');
            container.innerHTML = selectedJournals.map(j =>
                `<span class="badge bg-primary d-flex align-items-center gap-1" style="cursor:pointer" onclick="removeJournal('${j.issn}')">
                    ${j.title.substring(0, 25)}${j.title.length > 25 ? '...' : ''} ✕
                </span>`
            ).join('');
        }

        document.addEventListener('click', e => {
            if (!document.getElementById('journalWrapper').contains(e.target)) {
                jDropdown.style.display = 'none';
            }
        });

        // ==================== 期刊检索 ====================
        document.getElementById('journalForm').addEventListener('submit', async e => {
            e.preventDefault();
            const sources = getSelectedSources('journalSources');
            if (!sources.length) { showError('请选择至少一个数据源'); return; }

            let keyword = document.getElementById('journalKeyword').value.trim();
            const onlyEuropePMC = sources.length === 1 && sources[0] === 'europepmc';

            // 验证：必须有关键词，或者（仅Europe PMC时有已选期刊）
            if (!keyword && !(onlyEuropePMC && selectedJournals.length > 0)) {
                showError('请输入关键词' + (onlyEuropePMC ? '或选择期刊' : ''));
                return;
            }

            setLoading('journal', true); hideError();

            // AI生成检索式：如果输入看起来像自然语言（包含中文或超过3个单词）
            if (keyword && (keyword.match(/[\u4e00-\u9fa5]/) || keyword.split(/\s+/).length > 3)) {
                try {
                    document.getElementById('journalSearchBtn').innerHTML = '<span class="spinner-border spinner-border-sm"></span> AI生成检索式...';
                    keyword = await generateSearchQuery(keyword);
                    console.log('AI生成检索式:', keyword);
                } catch (e) {
                    console.warn('AI检索式生成失败，使用原始输入', e);
                }
            }

            // Europe PMC 特殊处理
            let euroQuery = keyword || '*';
            if (onlyEuropePMC) {
                const sYear = document.getElementById('euroStartYear').value;
                const eYear = document.getElementById('euroEndYear').value;
                const filterOA = document.getElementById('filterOA').checked;
                const filterFT = document.getElementById('filterFT').checked;

                let qParts = [];
                // 多选期刊支持
                if (selectedJournals.length > 0) {
                    const issnParts = selectedJournals.map(j => `ISSN:"${j.issn}"`);
                    qParts.push(`(${issnParts.join(' OR ')})`);
                }
                if (keyword) qParts.push(keyword);
                if (sYear && eYear) qParts.push(`(PUB_YEAR:[${sYear} TO ${eYear}])`);
                if (filterOA) qParts.push(`(OPEN_ACCESS:Y)`);
                if (filterFT) qParts.push(`(HAS_FT:Y)`);
                euroQuery = qParts.join(' AND ');

                // 统计
                try {
                    const BASE = "https://www.ebi.ac.uk/europepmc/webservices/rest";
                    const [r1, r2, r3] = await Promise.all([
                        fetch(`${BASE}/search?query=${encodeURIComponent(euroQuery)}&pageSize=1&format=json`),
                        fetch(`${BASE}/search?query=${encodeURIComponent(euroQuery.replace(/ AND \(OPEN_ACCESS:Y\)/g, '') + ' AND (OPEN_ACCESS:Y)')}&pageSize=1&format=json`),
                        fetch(`${BASE}/search?query=${encodeURIComponent(euroQuery.replace(/ AND \(HAS_FT:Y\)/g, '') + ' AND (HAS_FT:Y)')}&pageSize=1&format=json`)
                    ]);
                    const [d1, d2, d3] = await Promise.all([r1.json(), r2.json(), r3.json()]);
                    document.getElementById('euroStats').classList.remove('d-none');
                    document.getElementById('statTotal').textContent = (d1.hitCount || 0).toLocaleString();
                    document.getElementById('statOA').textContent = (d2.hitCount || 0).toLocaleString();
                    document.getElementById('statFT').textContent = (d3.hitCount || 0).toLocaleString();
                } catch (e) { console.error('统计失败', e); }
            } else {
                document.getElementById('euroStats').classList.add('d-none');
            }

            // 创建标签页
            createTabs('journal', sources);

            // 并行请求
            const requests = sources.map(async src => {
                showTabLoading('journal', src);
                try {
                    const data = await fetchJournalData(src, src === 'europepmc' ? euroQuery : keyword);
                    renderTabResults('journal', src, data);
                } catch (err) {
                    renderTabError('journal', src, err.message);
                }
            });

            await Promise.all(requests);
            document.getElementById('journalResults').classList.remove('d-none');
            setLoading('journal', false);
            document.getElementById('journalSearchBtn').innerHTML = '开始检索';
        });

        async function fetchJournalData(src, query) {
            let url, data;
            switch (src) {
                case 'europepmc':
                    const res1 = await fetch(`https://www.ebi.ac.uk/europepmc/webservices/rest/search?query=${encodeURIComponent(query)}&pageSize=25&format=json&resultType=lite`);
                    data = await res1.json();
                    return { count: data.hitCount || 0, items: (data.resultList?.result || []).map(a => ({ src: 'europepmc', title: a.title, authors: a.authorString, journal: a.journalTitle, year: a.pubYear, isOA: a.isOpenAccess === 'Y', hasFT: a.inEPMC === 'Y', link: a.doi ? `https://doi.org/${a.doi}` : `https://europepmc.org/article/MED/${a.pmid}` })) };
                case 'pubmed':
                    const res2a = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encodeURIComponent(query)}&retmode=json&retmax=25`);
                    const d2a = await res2a.json();
                    const ids = d2a.esearchresult?.idlist || [];
                    if (!ids.length) return { count: 0, items: [] };
                    const res2b = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=${ids.join(',')}&retmode=json`);
                    const d2b = await res2b.json();
                    return { count: parseInt(d2a.esearchresult?.count || 0), items: ids.map(id => { const a = d2b.result?.[id]; return a ? { src: 'pubmed', title: a.title, authors: a.authors?.map(x => x.name).join(', '), journal: a.source, year: a.pubdate?.split(' ')[0], pmid: id, link: `https://pubmed.ncbi.nlm.nih.gov/${id}/` } : null; }).filter(Boolean) };
                case 'plos':
                    const res3 = await fetch(`https://api.plos.org/search?q=${encodeURIComponent(query)}&wt=json&rows=25&fl=id,title,author,journal,publication_date,abstract`);
                    data = await res3.json();
                    return { count: data.response?.numFound || 0, items: (data.response?.docs || []).map(a => { let abs = Array.isArray(a.abstract) ? a.abstract[0] : (a.abstract || ''); return { src: 'plos', title: a.title, authors: Array.isArray(a.author) ? a.author.join(', ') : '', journal: a.journal, abstract: abs.substring(0, 100), link: `https://doi.org/${a.id}`, isOA: true, hasFT: true }; }) };
            }
        }

        // ==================== 药品检索 ====================
        document.getElementById('drugForm').addEventListener('submit', async e => {
            e.preventDefault();
            const sources = getSelectedSources('drugSources');
            if (!sources.length) { showError('请选择至少一个数据源'); return; }
            const query = document.getElementById('drugQuery').value.trim();
            if (!query) return;

            setLoading('drug', true); hideError();
            createTabs('drug', sources);

            const requests = sources.map(async src => {
                showTabLoading('drug', src);
                try {
                    const data = await fetchDrugData(src, query);
                    renderTabResults('drug', src, data);
                } catch (err) {
                    renderTabError('drug', src, err.message);
                }
            });

            await Promise.all(requests);
            document.getElementById('drugResults').classList.remove('d-none');
            setLoading('drug', false);
        });

        async function fetchDrugData(src, query) {
            switch (src) {
                case 'openfda':
                    const res1 = await fetch(`https://api.fda.gov/drug/label.json?search=${encodeURIComponent(query)}&limit=25`);
                    const d1 = await res1.json();
                    return { count: d1.meta?.results?.total || 0, items: (d1.results || []).map(a => ({ src: 'openfda', title: a.openfda?.brand_name?.[0] || a.openfda?.generic_name?.[0] || '未知', generic: a.openfda?.generic_name?.[0] || '', manufacturer: a.openfda?.manufacturer_name?.[0] || '', indication: (a.indications_and_usage?.[0] || '').substring(0, 120), route: a.openfda?.route?.[0] || '', link: a.openfda?.spl_id?.[0] ? `https://dailymed.nlm.nih.gov/dailymed/drugInfo.cfm?setid=${a.openfda.spl_id[0]}` : '#' })) };
                case 'rxnorm':
                    const res2 = await fetch(`https://rxnav.nlm.nih.gov/REST/drugs.json?name=${encodeURIComponent(query)}`);
                    const d2 = await res2.json();
                    const items = []; (d2.drugGroup?.conceptGroup || []).forEach(g => (g.conceptProperties || []).forEach(p => items.push({ src: 'rxnorm', name: p.name, rxcui: p.rxcui, tty: p.tty, link: `https://mor.nlm.nih.gov/RxNav/search?searchBy=RXCUI&searchTerm=${p.rxcui}` })));
                    return { count: items.length, items };
            }
        }

        // ==================== 临床试验检索 ====================
        document.getElementById('trialForm').addEventListener('submit', async e => {
            e.preventDefault();
            const query = document.getElementById('trialQuery').value.trim();
            if (!query) return;

            setLoading('trial', true); hideError();

            try {
                const res = await fetch(`https://clinicaltrials.gov/api/v2/studies?query.term=${encodeURIComponent(query)}&pageSize=25`);
                const data = await res.json();
                const count = data.totalCount || 0;
                const items = (data.studies || []).map(s => ({ title: s.protocolSection?.identificationModule?.officialTitle || s.protocolSection?.identificationModule?.briefTitle, nctId: s.protocolSection?.identificationModule?.nctId, status: s.protocolSection?.statusModule?.overallStatus, phase: s.protocolSection?.designModule?.phases?.join(', '), conditions: s.protocolSection?.conditionsModule?.conditions?.join(', '), link: `https://clinicaltrials.gov/study/${s.protocolSection?.identificationModule?.nctId}` }));

                document.getElementById('trialResults').classList.remove('d-none');
                const list = document.getElementById('trialResultsList');
                if (items.length === 0) {
                    list.innerHTML = '<div class="empty-state">无结果</div>';
                } else {
                    list.innerHTML = `<h5 class="mb-3">ClinicalTrials.gov 结果 <span class="badge bg-primary">${count.toLocaleString()}</span></h5>` + items.map(i => `<div class="result-card clinicaltrials"><h6><a href="${i.link}" target="_blank">${i.title}</a></h6><div class="small text-muted">${i.conditions}</div><div class="mt-1"><span class="badge bg-primary">${i.nctId}</span> <span class="badge bg-info">${i.status}</span> <span class="badge bg-secondary">${i.phase || 'N/A'}</span></div></div>`).join('');
                }
            } catch (err) {
                showError('ClinicalTrials.gov 请求失败: ' + err.message);
            }
            setLoading('trial', false);
        });

        // ==================== 标签页管理 ====================
        const SOURCE_NAMES = { europepmc: 'Europe PMC', pubmed: 'PubMed', plos: 'PLOS', openfda: 'openFDA', rxnorm: 'RxNorm' };

        function createTabs(page, sources) {
            const tabsEl = document.getElementById(`${page}Tabs`);
            const contentEl = document.getElementById(`${page}TabContent`);
            tabsEl.innerHTML = sources.map((s, i) => `<li class="nav-item"><button class="nav-link ${i === 0 ? 'active' : ''}" data-bs-toggle="tab" data-bs-target="#${page}Tab-${s}">${SOURCE_NAMES[s]} <span class="count-badge" id="${page}Count-${s}">...</span></button></li>`).join('');
            contentEl.innerHTML = sources.map((s, i) => `<div class="tab-pane fade ${i === 0 ? 'show active' : ''}" id="${page}Tab-${s}"></div>`).join('');
        }

        function showTabLoading(page, src) {
            document.getElementById(`${page}Tab-${src}`).innerHTML = '<div class="loading-overlay"><div class="spinner-border text-primary"></div></div>';
        }

        function renderTabResults(page, src, data) {
            document.getElementById(`${page}Count-${src}`).textContent = data.count.toLocaleString();
            const pane = document.getElementById(`${page}Tab-${src}`);
            if (!data.items.length) { pane.innerHTML = '<div class="empty-state">无结果</div>'; return; }
            pane.innerHTML = data.items.map(i => renderCard(src, i)).join('');
        }

        function renderTabError(page, src, msg) {
            document.getElementById(`${page}Count-${src}`).textContent = '!';
            document.getElementById(`${page}Tab-${src}`).innerHTML = `<div class="alert alert-warning">${SOURCE_NAMES[src]} 失败: ${msg}</div>`;
        }

        function renderCard(src, i) {
            const oa = i.isOA ? '<span class="badge bg-success">OA</span>' : '';
            const ft = i.hasFT ? '<span class="badge bg-info">全文</span>' : '';
            switch (src) {
                case 'europepmc': return `<div class="result-card europepmc"><h6><a href="${i.link}" target="_blank">${i.title}</a></h6><div class="text-muted small">${i.authors || ''}</div><div class="mt-1"><span class="badge bg-secondary">${i.journal || ''}</span> <span class="badge bg-light text-dark">${i.year || ''}</span> ${oa} ${ft}</div></div>`;
                case 'pubmed': return `<div class="result-card pubmed"><h6><a href="${i.link}" target="_blank">${i.title}</a></h6><div class="text-muted small">${i.authors || ''}</div><div class="mt-1"><span class="badge bg-secondary">${i.journal || ''}</span> <span class="badge bg-light text-dark">${i.year || ''}</span> <span class="badge bg-primary">PMID:${i.pmid}</span></div></div>`;
                case 'plos': return `<div class="result-card plos"><h6><a href="${i.link}" target="_blank">${i.title}</a></h6><div class="text-muted small">${i.authors || ''}</div><div class="mt-1">${oa} ${ft} <span class="badge bg-secondary">${i.journal || ''}</span></div></div>`;
                case 'openfda': return `<div class="result-card openfda"><h6><a href="${i.link}" target="_blank">${i.title}</a></h6><div class="small text-muted">通用名: ${i.generic} | 厂商: ${i.manufacturer}</div><div class="small mt-1">${i.indication}...</div><span class="badge bg-warning text-dark">${i.route}</span></div>`;
                case 'rxnorm': return `<div class="result-card rxnorm"><h6><a href="${i.link}" target="_blank">${i.name}</a></h6><div class="mt-1"><span class="badge bg-success">RxCUI: ${i.rxcui}</span> <span class="badge bg-secondary">${i.tty}</span></div></div>`;
            }
        }

        // ==================== 工具函数 ====================
        function setLoading(id, b) {
            const btn = document.getElementById(`${id}SearchBtn`);
            const spinner = document.getElementById(`${id}Spinner`);
            if (btn) btn.disabled = b;
            if (spinner) spinner.classList.toggle('d-none', !b);
        }
        function showError(m) { const e = document.getElementById('errorAlert'); e.textContent = m; e.classList.remove('d-none'); }
        function hideError() { document.getElementById('errorAlert').classList.add('d-none'); }

        // ==================== AI 问答功能 ====================
        const AI_CONFIG = {
            baseUrl: 'https://www.dmxapi.cn/v1',
            apiKey: 'sk-ANZikovLXwI5QG7w8yHVAisdGeugkfGyq7W1I9ZIavPBhRQs'
        };

        let knowledgeBase = [];  // 存储检索结果
        let chatHistory = [];    // 对话历史

        // 切换AI面板
        function toggleAIPanel() {
            document.getElementById('aiPanel').classList.toggle('show');
        }

        // 更新知识库（每次检索后调用）
        function updateKnowledgeBase(source, items) {
            // 移除该来源的旧数据
            knowledgeBase = knowledgeBase.filter(k => k.source !== source);
            // 添加新数据
            items.forEach(item => {
                knowledgeBase.push({
                    source: source,
                    title: item.title || item.name || '',
                    content: item.authors || item.indication || item.conditions || '',
                    journal: item.journal || '',
                    year: item.year || '',
                    link: item.link || ''
                });
            });
            // 更新UI
            updateKBInfo();
        }

        function updateKBInfo() {
            const count = knowledgeBase.length;
            document.getElementById('kbInfo').textContent = `知识库: ${count} 条记录`;
            const badge = document.getElementById('kbBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // 发送AI消息
        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const question = input.value.trim();
            if (!question) return;

            if (knowledgeBase.length === 0) {
                addMessage('assistant', '请先使用上方的检索功能搜索文献，我将基于检索结果回答您的问题。');
                return;
            }

            // 添加用户消息
            addMessage('user', question);
            input.value = '';

            // 构建上下文
            const context = knowledgeBase.slice(0, 20).map((k, i) =>
                `[${i + 1}] ${k.title}${k.journal ? ` (${k.journal} ${k.year})` : ''}${k.content ? `: ${k.content.substring(0, 200)}` : ''}`
            ).join('\n');

            const systemPrompt = `你是一位专业的医学知识助手。请基于以下检索到的医学文献信息回答用户问题。回答要简洁专业，如果信息不足请说明。

检索到的相关文献：
${context}`;

            // 显示加载状态
            const loadingId = addMessage('assistant', '<i class="spinner-border spinner-border-sm"></i> 正在思考...');
            const model = document.getElementById('modelSelect').value;

            try {
                const response = await fetch(`${AI_CONFIG.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...chatHistory.slice(-6),  // 保留最近3轮对话
                            { role: 'user', content: question }
                        ],
                        max_tokens: 1000
                    })
                });

                const data = await response.json();
                const answer = data.choices?.[0]?.message?.content || '抱歉，未能获取回答。';

                // 更新消息
                updateMessage(loadingId, answer);

                // 保存到历史
                chatHistory.push({ role: 'user', content: question });
                chatHistory.push({ role: 'assistant', content: answer });
            } catch (err) {
                updateMessage(loadingId, '请求失败: ' + err.message);
            }
        }

        function addMessage(role, content) {
            const msgId = 'msg-' + Date.now();
            const messagesEl = document.getElementById('aiMessages');
            const msgDiv = document.createElement('div');
            msgDiv.id = msgId;
            msgDiv.className = `ai-message ${role}`;
            msgDiv.innerHTML = content;
            messagesEl.appendChild(msgDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            return msgId;
        }

        function updateMessage(msgId, content) {
            const el = document.getElementById(msgId);
            if (el) el.innerHTML = content;
        }

        // 修改原有的renderTabResults函数，添加知识库更新
        const originalRenderTabResults = renderTabResults;
        renderTabResults = function (page, src, data) {
            originalRenderTabResults(page, src, data);
            // 更新知识库
            if (data.items && data.items.length > 0) {
                updateKnowledgeBase(src, data.items);
            }
        };

        // ==================== RAG 智能问答系统 ====================

        // 期刊多选相关
        let qaSelectedJournals = [];  // [{title, issn}]

        function toggleQAJournalFilter() {
            const euroChecked = document.querySelector('#qaSources input[value="europepmc"]').checked;
            const filterEl = document.getElementById('qaJournalFilter');
            filterEl.style.display = euroChecked ? 'block' : 'none';
        }

        // QA页面期刊联想
        const qaJournalInput = document.getElementById('qaJournalInput');
        const qaJournalDropdown = document.getElementById('qaJournalDropdown');

        if (qaJournalInput) {
            let qaDebounce;
            qaJournalInput.addEventListener('input', e => {
                clearTimeout(qaDebounce);
                qaDebounce = setTimeout(() => {
                    const v = e.target.value.trim().toLowerCase();
                    if (v.length < 2) { qaJournalDropdown.style.display = 'none'; return; }

                    if (ALL_JOURNALS.length === 0) {
                        qaJournalDropdown.innerHTML = '<div class="j-item text-warning">期刊列表加载中...</div>';
                        qaJournalDropdown.style.display = 'block';
                        return;
                    }

                    const matched = ALL_JOURNALS.filter(j =>
                        j.title.toLowerCase().includes(v) ||
                        j.abbr.toLowerCase().includes(v)
                    ).slice(0, 20);

                    if (matched.length) {
                        qaJournalDropdown.innerHTML = matched.map(j =>
                            `<div class="j-item" onclick="addQAJournal('${j.title.replace(/'/g, "\\'")}','${j.issn}')">
                                <strong>${j.title}</strong><br>
                                <small class="text-muted">ISSN: ${j.issn}</small>
                            </div>`
                        ).join('');
                    } else {
                        qaJournalDropdown.innerHTML = '<div class="j-item text-muted">未找到匹配期刊</div>';
                    }
                    qaJournalDropdown.style.display = 'block';
                }, 150);
            });

            document.addEventListener('click', e => {
                if (!document.getElementById('qaJournalFilter')?.contains(e.target)) {
                    qaJournalDropdown.style.display = 'none';
                }
            });
        }

        function addQAJournal(title, issn) {
            // 检查是否已存在
            if (qaSelectedJournals.some(j => j.issn === issn)) return;

            qaSelectedJournals.push({ title, issn });
            renderQAJournalTags();
            qaJournalInput.value = '';
            qaJournalDropdown.style.display = 'none';
        }

        function removeQAJournal(issn) {
            qaSelectedJournals = qaSelectedJournals.filter(j => j.issn !== issn);
            renderQAJournalTags();
        }

        function renderQAJournalTags() {
            const container = document.getElementById('qaSelectedJournals');
            if (qaSelectedJournals.length === 0) {
                container.innerHTML = '';
                document.getElementById('qaJournalTip').textContent = '可添加多个期刊，如需搜索所有期刊请留空';
            } else {
                container.innerHTML = qaSelectedJournals.map(j =>
                    `<span class="badge bg-success d-flex align-items-center gap-1" style="font-size:0.85rem;">
                        ${j.title.substring(0, 30)}${j.title.length > 30 ? '...' : ''}
                        <button type="button" class="btn-close btn-close-white" style="font-size:0.6rem;" 
                            onclick="removeQAJournal('${j.issn}')"></button>
                    </span>`
                ).join('');
                document.getElementById('qaJournalTip').textContent = `已选择 ${qaSelectedJournals.length} 个期刊`;
            }
        }

        // 页面加载时初始化期刊筛选显示状态
        setTimeout(toggleQAJournalFilter, 100);

        // 更新进度
        function updateQAProgress(percent, text) {
            document.getElementById('qaProgress').style.width = percent + '%';
            document.getElementById('qaStatusText').textContent = text;
        }

        // 分片函数
        function chunkText(text, maxLen = 400) {
            if (!text || text.length <= maxLen) return [text];
            const sentences = text.split(/[.。!！?？\n]+/).filter(s => s.trim());
            const chunks = [];
            let current = '';
            for (const s of sentences) {
                if ((current + s).length > maxLen && current) {
                    chunks.push(current.trim());
                    current = s;
                } else {
                    current += (current ? '. ' : '') + s;
                }
            }
            if (current.trim()) chunks.push(current.trim());
            return chunks;
        }

        // 向量化API调用
        async function getEmbeddings(texts) {
            const response = await fetch(`${AI_CONFIG.baseUrl}/embeddings`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                },
                body: JSON.stringify({
                    model: 'text-embedding-3-large',
                    input: texts
                })
            });
            const data = await response.json();
            return data.data?.map(d => d.embedding) || [];
        }

        // 余弦相似度
        function cosineSimilarity(a, b) {
            let dotProduct = 0, normA = 0, normB = 0;
            for (let i = 0; i < a.length; i++) {
                dotProduct += a[i] * b[i];
                normA += a[i] * a[i];
                normB += b[i] * b[i];
            }
            return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        }

        // Rerank API调用
        async function rerankDocuments(query, documents) {
            try {
                const response = await fetch(`${AI_CONFIG.baseUrl}/rerank`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'qwen3-rerank',
                        query: query,
                        documents: documents.map(d => d.text),
                        top_n: 10
                    })
                });
                const data = await response.json();
                // 根据rerank结果重排
                if (data.results) {
                    return data.results.map(r => ({
                        ...documents[r.index],
                        score: r.relevance_score
                    }));
                }
            } catch (e) {
                console.warn('Rerank API失败，使用相似度排序:', e);
            }
            // 降级：按相似度排序
            return documents.sort((a, b) => b.similarity - a.similarity).slice(0, 10);
        }

        // 使用AI生成多个检索关键词（用于组合查询）
        async function generateSearchQueries(question, retries = 3) {
            const prompt = `你是资深医学文献检索专家。请对用户问题进行深度语义分析，推理出核心检索概念。

要求：
1. **拒绝简单翻译**：不要直接翻译问题，要推理出背后的医学概念（MeSH Terms）
2. **多维扩展**：生成3-4个不同的检索组合，覆盖疾病本名、别名、相关药物、病理机制等不同角度
3. **专业精准**：每个组合包含2-3个英文医学专业术语（空格分隔）
4. 只返回关键词组合，每行一个，不要解释

问题：${question}

推导出的检索组合（每行一个）：`;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(`${AI_CONFIG.baseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gemini-3-flash-preview-thinking',
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 200
                        })
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content?.trim();
                    if (content && content.length > 2) {
                        // 按行分割，过滤空行和编号
                        const queries = content.split('\n')
                            .map(line => line.replace(/^\d+[\.\)]\s*/, '').trim())
                            .filter(line => line.length > 2 && !line.includes('：') && !line.includes(':'));
                        if (queries.length > 0) return queries.slice(0, 4);
                    }
                } catch (e) {
                    console.warn(`检索式生成失败(${i + 1}/${retries}):`, e);
                    if (i < retries - 1) await new Promise(r => setTimeout(r, 1000));
                }
            }
            return [question];  // 重试失败后使用原问题
        }

        // 主RAG流程
        async function startRAGQuery() {
            const question = document.getElementById('qaQuestion').value.trim();
            if (!question) {
                showError('请输入问题');
                return;
            }

            const sources = getSelectedSources('qaSources');
            if (!sources.length) {
                showError('请选择至少一个数据源');
                return;
            }

            // 重置UI
            hideError();
            document.getElementById('qaStatus').classList.remove('d-none');
            document.getElementById('qaAnswer').classList.add('d-none');
            document.getElementById('qaSearchBtn').disabled = true;
            document.getElementById('qaSpinner').classList.remove('d-none');

            // 检查是否直接问答模式
            const isDirectMode = document.getElementById('qaDirectMode').checked;

            try {
                if (isDirectMode) {
                    // === 直接问答模式：跳过检索 ===
                    await handleDirectQuery(question);
                    return;
                }

                // === RAG模式：检索+生成 ===
                // === 阶段0: 生成多个检索词组合 ===
                updateQAProgress(5, '正在使用AI生成检索词组合...');
                const searchQueries = await generateSearchQueries(question);
                console.log('生成的检索词组合:', searchQueries);

                // 显示检索式
                document.getElementById('qaDetailQuery').textContent = searchQueries.join(' | ');
                document.getElementById('qaStatusText').innerHTML = `检索组合: <strong>${searchQueries.join('</strong> + <strong>')}</strong>`;

                // === 阶段1: 多查询并行检索 ===
                updateQAProgress(15, `正在使用 ${searchQueries.length} 个检索组合检索...`);
                const allResults = [];
                const seenTitles = new Set(); // 用于去重

                // 每个查询组合 x 每个数据源 并行执行
                const allPromises = [];
                for (const query of searchQueries) {
                    for (const src of sources) {
                        allPromises.push(
                            fetchForRAG(src, query)
                                .then(data => data.items || [])
                                .catch(e => {
                                    console.warn(`${src} 检索失败 (${query}):`, e);
                                    return [];
                                })
                        );
                    }
                }
                const allResponses = await Promise.all(allPromises);

                // 合并结果并去重（按标题）
                allResponses.forEach(items => {
                    items.forEach(item => {
                        const titleKey = (item.title || '').toLowerCase().trim();
                        if (titleKey && !seenTitles.has(titleKey)) {
                            seenTitles.add(titleKey);
                            allResults.push(item);
                        }
                    });
                });

                // 填充检索详情
                document.getElementById('qaDetailSearchCount').textContent = allResults.length;
                document.getElementById('qaDetailSearchResults').innerHTML = allResults.map((r, i) =>
                    `<div class="mb-1 pb-1 border-bottom">[${i + 1}] <strong>${r.title || '无标题'}</strong><br><span class="text-muted">${r.journal || ''} ${r.year || ''}</span></div>`
                ).join('');

                if (allResults.length === 0) {
                    throw new Error(`未检索到相关文献（检索组合: ${searchQueries.join(', ')}），请尝试其他问题`);
                }

                // === 阶段2: 分片 ===
                updateQAProgress(30, '正在对文献进行分片处理...');
                const chunks = [];
                allResults.forEach((item, idx) => {
                    const text = `${item.title || ''}. ${item.authors || item.content || item.indication || ''}`;
                    const textChunks = chunkText(text);
                    textChunks.forEach(chunk => {
                        chunks.push({
                            text: chunk,
                            source: item,
                            sourceIdx: idx
                        });
                    });
                });

                // 填充分片详情
                document.getElementById('qaDetailChunkCount').textContent = chunks.length;
                document.getElementById('qaDetailChunks').innerHTML = chunks.map((c, i) =>
                    `<div class="mb-1 p-1 bg-light rounded">[${i + 1}] ${c.text}</div>`
                ).join('');

                // === 阶段3: 向量化 ===
                updateQAProgress(50, '正在进行向量化嵌入 (Embedding)...');
                const chunkTexts = chunks.map(c => c.text);
                const questionEmbedding = (await getEmbeddings([question]))[0];

                // 分批处理避免超限
                const batchSize = 50;
                let allChunkEmbeddings = [];
                for (let i = 0; i < chunkTexts.length; i += batchSize) {
                    const batch = chunkTexts.slice(i, i + batchSize);
                    const embeddings = await getEmbeddings(batch);
                    allChunkEmbeddings.push(...embeddings);
                    updateQAProgress(50 + (i / chunkTexts.length) * 20, `向量化进度: ${Math.min(i + batchSize, chunkTexts.length)}/${chunkTexts.length}`);
                }

                // 计算相似度
                chunks.forEach((chunk, i) => {
                    if (allChunkEmbeddings[i] && questionEmbedding) {
                        chunk.similarity = cosineSimilarity(questionEmbedding, allChunkEmbeddings[i]);
                    } else {
                        chunk.similarity = 0;
                    }
                });

                // 初筛Top-30
                const topChunks = chunks.sort((a, b) => b.similarity - a.similarity).slice(0, 30);

                // 填充相似度详情
                document.getElementById('qaDetailSimilar').innerHTML = topChunks.map((c, i) =>
                    `<div class="mb-1">[${i + 1}] <span class="text-primary">${(c.similarity * 100).toFixed(1)}%</span> ${c.text}</div>`
                ).join('');

                // === 阶段4: 重排 ===
                updateQAProgress(75, '正在使用Rerank模型重新排序...');
                const rerankedChunks = await rerankDocuments(question, topChunks);
                const finalChunks = rerankedChunks.slice(0, 10);

                // 填充重排详情
                document.getElementById('qaDetailRerank').innerHTML = finalChunks.map((c, i) =>
                    `<div class="mb-1">[${i + 1}] <strong>${c.source?.title || '未知'}</strong><br><span class="text-muted small">${c.text}</span></div>`
                ).join('');

                // === 阶段5: 生成回答（支持多模型） ===
                updateQAProgress(85, '正在生成AI回答...');

                // 获取选中的模型
                const selectedModels = Array.from(document.querySelectorAll('#qaModelSelect input:checked'))
                    .map(cb => ({ value: cb.value, name: cb.parentElement.textContent.trim() }));

                if (selectedModels.length === 0) {
                    showError('请至少选择一个模型');
                    return;
                }

                // 构建带编号的上下文
                const contextWithRefs = finalChunks.map((c, i) =>
                    `[${i + 1}] ${c.source.title || '未知标题'}\n内容: ${c.text}`
                ).join('\n\n');

                const systemPrompt = `严格基于以下学术文献回答问题。

核心要求：
1. **直接回答**：开门见山直接给出医学结论或分析，**严禁**使用"基于文献"、"根据搜索结果"、"通过分析资料"等任何铺垫语句。
2. **循证为本**：内容必须紧密结合文献，但不要口头强调这一点。
3. **实用导向**：给出具体、可操作的建议。
4. **规范引用**：在关键信息后标注来源编号如[1][2]。
5. **结构清晰**：分点论述，重点突出。
6. **如实告知**：资料不足时说明。
7. 不要在回答末尾列出参考文献。

参考文献：
${contextWithRefs}`;

                // 清空回答区并准备多模型容器（3个及以内横向，超过3个纵向）
                const answerContainer = document.getElementById('qaAnswerContent');
                const isHorizontal = selectedModels.length <= 3;
                const colClass = isHorizontal ? `col-md-${Math.floor(12 / selectedModels.length)}` : '';

                answerContainer.innerHTML = isHorizontal
                    ? `<div class="row g-3">${selectedModels.map(m =>
                        `<div class="${colClass}">
                            <div class="p-3 bg-white border rounded h-100" id="answer-${m.value.replace(/[^a-z0-9]/gi, '')}">
                                <div class="fw-bold text-primary mb-2" style="font-size:0.85rem;">${m.name}</div>
                                <div class="answer-body text-muted">生成中...</div>
                            </div>
                        </div>`).join('')}</div>`
                    : selectedModels.map(m =>
                        `<div class="mb-3 p-3 bg-white border rounded" id="answer-${m.value.replace(/[^a-z0-9]/gi, '')}">
                            <div class="fw-bold text-primary mb-2">${m.name}</div>
                            <div class="answer-body text-muted">生成中...</div>
                        </div>`).join('');

                // 并行调用所有选中模型
                const modelPromises = selectedModels.map(async (modelInfo) => {
                    const containerId = `answer-${modelInfo.value.replace(/[^a-z0-9]/gi, '')}`;
                    try {
                        const response = await fetch(`${AI_CONFIG.baseUrl}/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                            },
                            body: JSON.stringify({
                                model: modelInfo.value,
                                messages: [
                                    { role: 'system', content: systemPrompt },
                                    { role: 'user', content: question }
                                ]
                            })
                        });
                        const aiData = await response.json();
                        let answer = aiData.choices?.[0]?.message?.content || '未能生成回答';

                        // 渲染Markdown并转换引用为上标
                        let rendered = typeof marked !== 'undefined' ? marked.parse(answer) : answer.replace(/\n/g, '<br>');
                        rendered = rendered.replace(/\[(\d+)\]/g, '<sup class="text-primary" style="font-size:0.7em">[$1]</sup>');

                        document.querySelector(`#${containerId} .answer-body`).innerHTML = rendered;
                        document.querySelector(`#${containerId} .answer-body`).classList.remove('text-muted');
                    } catch (e) {
                        document.querySelector(`#${containerId} .answer-body`).innerHTML = `<span class="text-danger">生成失败: ${e.message}</span>`;
                    }
                });

                // 等待所有模型完成后更新进度
                Promise.all(modelPromises).then(() => {
                    updateQAProgress(100, '全部模型生成完成！');
                });

                // 保存对话上下文（使用第一个模型）
                window.qaContext = {
                    systemPrompt: systemPrompt,
                    history: [{ role: 'user', content: question }],
                    models: selectedModels,
                    refs: finalChunks
                };

                // 先显示结果区域（进度会在模型完成后更新）

                // 显示参考文献
                const refListHtml = finalChunks.map((c, i) => {
                    const source = c.source;
                    return `<div class="mb-2">
                        <strong>[${i + 1}]</strong> 
                        <a href="${source.link || '#'}" target="_blank">${source.title || '未知标题'}</a>
                        ${source.journal ? `<span class="text-muted"> (${source.journal}${source.year ? ', ' + source.year : ''})</span>` : ''}
                    </div>`;
                }).join('');
                document.getElementById('qaRefList').innerHTML = refListHtml;

                // 显示结果区域（RAG模式显示参考文献）
                document.getElementById('qaReferences').classList.remove('d-none');
                document.getElementById('qaAnswer').classList.remove('d-none');

            } catch (err) {
                showError('处理失败: ' + err.message);
            } finally {
                document.getElementById('qaSearchBtn').disabled = false;
                document.getElementById('qaSpinner').classList.add('d-none');
            }
        }

        // 直接问答模式（不检索文献）
        async function handleDirectQuery(question) {
            try {
                updateQAProgress(30, '正在生成AI回答（直接模式）...');

                // 获取选中的模型
                const selectedModels = Array.from(document.querySelectorAll('#qaModelSelect input:checked'))
                    .map(cb => ({ value: cb.value, name: cb.parentElement.textContent.trim() }));

                if (selectedModels.length === 0) {
                    showError('请至少选择一个模型');
                    return;
                }

                const directPrompt = `请以专业医学顾问的角度回答以下问题。

核心要求：
1. **直接回答**：开门见山，**严禁**使用"作为AI"、"你好"、"根据医学知识"等任何非内容性开场白。
2. **专业实用**：回答准确、具体、便于应用。
3. **结构清晰**：分点论述。`;

                // 准备多模型容器
                const answerContainer = document.getElementById('qaAnswerContent');
                const isHorizontal = selectedModels.length <= 3;
                const colClass = isHorizontal ? `col-md-${Math.floor(12 / selectedModels.length)}` : '';

                answerContainer.innerHTML = isHorizontal
                    ? `<div class="row g-3">${selectedModels.map(m =>
                        `<div class="${colClass}">
                            <div class="p-3 bg-white border rounded h-100" id="answer-${m.value.replace(/[^a-z0-9]/gi, '')}">
                                <div class="fw-bold text-primary mb-2" style="font-size:0.85rem;">${m.name}</div>
                                <div class="answer-body text-muted">生成中...</div>
                            </div>
                        </div>`).join('')}</div>`
                    : selectedModels.map(m =>
                        `<div class="mb-3 p-3 bg-white border rounded" id="answer-${m.value.replace(/[^a-z0-9]/gi, '')}">
                            <div class="fw-bold text-primary mb-2">${m.name}</div>
                            <div class="answer-body text-muted">生成中...</div>
                        </div>`).join('');

                // 并行调用所有选中模型
                const modelPromises = selectedModels.map(async (modelInfo) => {
                    const containerId = `answer-${modelInfo.value.replace(/[^a-z0-9]/gi, '')}`;
                    try {
                        const response = await fetch(`${AI_CONFIG.baseUrl}/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                            },
                            body: JSON.stringify({
                                model: modelInfo.value,
                                messages: [
                                    { role: 'system', content: directPrompt },
                                    { role: 'user', content: question }
                                ]
                            })
                        });
                        const aiData = await response.json();
                        let answer = aiData.choices?.[0]?.message?.content || '未能生成回答';

                        let rendered = typeof marked !== 'undefined' ? marked.parse(answer) : answer.replace(/\n/g, '<br>');
                        document.querySelector(`#${containerId} .answer-body`).innerHTML = rendered;
                        document.querySelector(`#${containerId} .answer-body`).classList.remove('text-muted');
                    } catch (e) {
                        document.querySelector(`#${containerId} .answer-body`).innerHTML = `<span class="text-danger">生成失败: ${e.message}</span>`;
                    }
                });

                // 等待所有模型完成
                Promise.all(modelPromises).then(() => {
                    updateQAProgress(100, '全部模型生成完成！');
                });

                // 隐藏参考文献区域（直接模式无文献）
                document.getElementById('qaReferences').classList.add('d-none');
                document.getElementById('qaAnswer').classList.remove('d-none');

            } catch (err) {
                showError('直接问答失败: ' + err.message);
            } finally {
                document.getElementById('qaSearchBtn').disabled = false;
                document.getElementById('qaSpinner').classList.add('d-none');
            }
        }

        // RAG专用检索函数
        async function fetchForRAG(src, query) {
            switch (src) {
                case 'europepmc':
                    // 如果有选中期刊，使用ISSN筛选
                    let euroQuery = query;
                    if (qaSelectedJournals.length > 0) {
                        const issnQueries = qaSelectedJournals.map(j => `ISSN:"${j.issn}"`).join(' OR ');
                        euroQuery = `(${issnQueries}) AND (${query})`;
                    }
                    const res1 = await fetch(`https://www.ebi.ac.uk/europepmc/webservices/rest/search?query=${encodeURIComponent(euroQuery)}&pageSize=20&format=json&resultType=lite`);
                    const d1 = await res1.json();
                    return { items: (d1.resultList?.result || []).map(a => ({ src: 'europepmc', title: a.title, authors: a.authorString, journal: a.journalTitle, year: a.pubYear, link: a.doi ? `https://doi.org/${a.doi}` : `https://europepmc.org/article/MED/${a.pmid}` })) };
                case 'pubmed':
                    const res2a = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encodeURIComponent(query)}&retmode=json&retmax=15`);
                    const d2a = await res2a.json();
                    const ids = d2a.esearchresult?.idlist || [];
                    if (!ids.length) return { items: [] };
                    const res2b = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=${ids.join(',')}&retmode=json`);
                    const d2b = await res2b.json();
                    return { items: ids.map(id => { const a = d2b.result?.[id]; return a ? { src: 'pubmed', title: a.title, authors: a.authors?.map(x => x.name).join(', '), journal: a.source, year: a.pubdate?.split(' ')[0], link: `https://pubmed.ncbi.nlm.nih.gov/${id}/` } : null; }).filter(Boolean) };
                case 'plos':
                    const res3 = await fetch(`https://api.plos.org/search?q=${encodeURIComponent(query)}&wt=json&rows=15&fl=id,title,author,journal,abstract`);
                    const d3 = await res3.json();
                    return { items: (d3.response?.docs || []).map(a => ({ src: 'plos', title: a.title, authors: Array.isArray(a.author) ? a.author.join(', ') : '', journal: a.journal, content: Array.isArray(a.abstract) ? a.abstract[0] : a.abstract, link: `https://doi.org/${a.id}` })) };
                case 'openfda':
                    const res4 = await fetch(`https://api.fda.gov/drug/label.json?search=${encodeURIComponent(query)}&limit=10`);
                    const d4 = await res4.json();
                    return { items: (d4.results || []).map(a => ({ src: 'openfda', title: a.openfda?.brand_name?.[0] || a.openfda?.generic_name?.[0] || '未知', indication: (a.indications_and_usage?.[0] || '').substring(0, 500), link: '#' })) };
                default:
                    return { items: [] };
            }
        }

        // 多轮对话：继续提问
        async function askFollowUp() {
            const followUp = document.getElementById('qaFollowUp').value.trim();
            if (!followUp || !window.qaContext) return;

            const input = document.getElementById('qaFollowUp');
            input.disabled = true;

            // 添加用户问题到对话历史
            window.qaContext.history.push({ role: 'user', content: followUp });

            try {
                const response = await fetch(`${AI_CONFIG.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AI_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: window.qaContext.model,
                        messages: [
                            { role: 'system', content: window.qaContext.systemPrompt },
                            ...window.qaContext.history
                        ]
                    })
                });

                const data = await response.json();
                const answer = data.choices?.[0]?.message?.content || '抱歉，未能生成回答。';

                // 保存到历史
                window.qaContext.history.push({ role: 'assistant', content: answer });

                // 追加显示
                const content = document.getElementById('qaAnswerContent');
                const newAnswer = typeof marked !== 'undefined' ? marked.parse(answer) : answer.replace(/\n/g, '<br>');
                content.innerHTML += `<hr class="my-3"><div class="text-muted small mb-2">追问：${followUp}</div>${newAnswer}`;

            } catch (err) {
                showError('追问失败: ' + err.message);
            } finally {
                input.value = '';
                input.disabled = false;
                input.focus();
            }
        }
    </script>
</body>

</html>