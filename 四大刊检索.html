<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Europe PMC æ–‡çŒ®åˆ†æåŠ©æ‰‹ Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f4f7f6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .search-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 25px;
            margin-top: 30px;
        }

        .journal-dropdown {
            position: absolute;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            z-index: 2000;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
            background: white;
            display: none;
        }

        .list-group-item-action {
            cursor: pointer;
        }

        .list-group-item-action:hover {
            background-color: #e9ecef;
        }

        .stat-box {
            border-radius: 10px;
            padding: 15px;
            color: white;
            text-align: center;
        }

        .bg-blue {
            background: #4e73df;
        }

        .bg-green {
            background: #1cc88a;
        }

        .bg-info {
            background: #36b9cc;
        }

        .result-card {
            border-left: 4px solid #4e73df;
            margin-bottom: 15px;
            transition: 0.3s;
        }

        .result-card:hover {
            transform: translateX(5px);
        }

        .loading-spinner {
            display: none;
        }
    </style>
</head>

<body>

    <div class="container mb-5">
        <div class="search-card">
            <h2 class="text-center mb-4">ğŸ”¬ Europe PMC æ™ºèƒ½æ–‡çŒ®åˆ†æç³»ç»Ÿ</h2>

            <form id="searchForm" class="row g-3">
                <div class="col-md-6 position-relative" id="journalWrapper">
                    <label class="form-label fw-bold">æœŸåˆŠåç§° (æ”¯æŒè”æƒ³, å¦‚: Lancet, Nature)</label>
                    <input type="text" id="journalInput" class="form-control" placeholder="è¾“å…¥1-2ä¸ªå­—æ¯å¼€å§‹åŒ¹é…..."
                        autocomplete="off">
                    <input type="hidden" id="selectedIssn">
                    <div id="journalDropdown" class="list-group journal-dropdown"></div>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">æ£€ç´¢å…³é”®è¯ (å¯ç•™ç©ºè¿›è¡Œç»Ÿè®¡)</label>
                    <input type="text" id="keyword" class="form-control" placeholder="ä¾‹å¦‚: Diabetes, AI Healthcare...">
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-bold">å¼€å§‹å¹´ä»½</label>
                    <input type="number" id="startYear" class="form-control" value="2020">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">ç»“æŸå¹´ä»½</label>
                    <input type="number" id="endYear" class="form-control" value="2026">
                </div>

                <div class="col-md-3 d-flex align-items-end">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="onlyOA">
                        <label class="form-check-label fw-bold" for="onlyOA">ä»…é™ Open Access</label>
                    </div>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="onlyFT">
                        <label class="form-check-label fw-bold" for="onlyFT">ä»…é™å…¨æ–‡å¯ç”¨</label>
                    </div>
                </div>

                <div class="col-12 text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg px-5" id="searchBtn">
                        <span class="spinner-border spinner-border-sm loading-spinner" id="btnSpinner"></span>
                        ç«‹å³æ£€ç´¢å¹¶ç”Ÿæˆç»Ÿè®¡
                    </button>
                </div>
            </form>
        </div>

        <div id="statsPanel" class="row mt-4 d-none">
            <div class="col-md-4 mb-3">
                <div class="stat-box bg-blue">
                    <div class="small">ç¬¦åˆæ¡ä»¶æ€»æ–‡çŒ®</div>
                    <h3 id="statTotal">0</h3>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stat-box bg-green">
                    <div class="small">Open Access æ•°é‡</div>
                    <h3 id="statOA">0</h3>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stat-box bg-info">
                    <div class="small">å…¨æ–‡ (Full Text) æ•°é‡</div>
                    <h3 id="statFT">0</h3>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <div id="errorAlert" class="alert alert-danger d-none"></div>
            <div id="resultsList"></div>
            <div class="text-center mt-3">
                <button id="loadMore" class="btn btn-outline-primary d-none">åŠ è½½æ›´å¤šç»“æœ</button>
            </div>
        </div>
    </div>

    <script>
        let cursorMark = "*";
        const API_BASE = "https://www.ebi.ac.uk/europepmc/webservices/rest";

        // --- 1. æœŸåˆŠè”æƒ³é€»è¾‘ ---
        const jInput = document.getElementById('journalInput');
        const jDropdown = document.getElementById('journalDropdown');
        const jIssn = document.getElementById('selectedIssn');

        // æœŸåˆŠåˆ—è¡¨ - ä»å¤–éƒ¨ JSON åŠ è½½
        let ALL_JOURNALS = [];

        // é¡µé¢åŠ è½½æ—¶å¼‚æ­¥è·å–æœŸåˆŠåˆ—è¡¨
        (async function loadJournals() {
            try {
                const res = await fetch('journals.json');
                ALL_JOURNALS = await res.json();
                console.log(`å·²åŠ è½½ ${ALL_JOURNALS.length} ä¸ªæœŸåˆŠ`);
            } catch (err) {
                console.error('åŠ è½½æœŸåˆŠåˆ—è¡¨å¤±è´¥:', err);
                // ä½¿ç”¨å¤‡ç”¨çš„å››å¤§åˆŠåˆ—è¡¨
                ALL_JOURNALS = [
                    { title: "The New England journal of medicine", issn: "0028-4793", abbr: "N Engl J Med" },
                    { title: "Lancet (London, England)", issn: "0140-6736", abbr: "Lancet" },
                    { title: "JAMA", issn: "0098-7484", abbr: "JAMA" },
                    { title: "BMJ (Clinical research ed.)", issn: "0959-8138", abbr: "BMJ" }
                ];
            }
        })();

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // æœŸåˆŠæœç´¢ï¼ˆå¸¦é˜²æŠ–ï¼‰
        jInput.addEventListener('input', debounce((e) => {
            const val = e.target.value.trim().toLowerCase();
            if (val.length < 2) {
                jDropdown.style.display = 'none';
                return;
            }

            // æœ¬åœ°è¿‡æ»¤åŒ¹é… - é™åˆ¶æœ€å¤šæ˜¾ç¤º20æ¡
            const matched = ALL_JOURNALS.filter(j =>
                j.title.toLowerCase().includes(val) ||
                j.abbr.toLowerCase().includes(val) ||
                j.issn.includes(val)
            ).slice(0, 20);

            if (matched.length > 0) {
                jDropdown.innerHTML = matched.map(j => `
                <button type="button" class="list-group-item list-group-item-action" 
                        onclick="selectJournal('${j.title.replace(/'/g, "\\'")}', '${j.issn}')">
                    <strong>${j.title}</strong> <br>
                    <small class="text-muted">ISSN: ${j.issn} | ç¼©å†™: ${j.abbr}</small>
                </button>
            `).join('');
                jDropdown.style.display = 'block';
            } else {
                jDropdown.innerHTML = '<div class="list-group-item text-muted">æœªæ‰¾åˆ°åŒ¹é…çš„æœŸåˆŠ</div>';
                jDropdown.style.display = 'block';
            }
        }, 200));

        function selectJournal(title, issn) {
            jInput.value = title;
            jIssn.value = issn;
            jDropdown.style.display = 'none';
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
        document.addEventListener('click', (e) => {
            if (!document.getElementById('journalWrapper').contains(e.target)) {
                jDropdown.style.display = 'none';
            }
        });

        // --- 2. æ ¸å¿ƒæ£€ç´¢é€»è¾‘ ---
        document.getElementById('searchForm').addEventListener('submit', (e) => {
            e.preventDefault();
            cursorMark = "*";
            document.getElementById('resultsList').innerHTML = "";
            document.getElementById('errorAlert').classList.add('d-none');
            performSearch();
        });

        async function performSearch() {
            const keyword = document.getElementById('keyword').value.trim();
            const issn = jIssn.value;
            const jName = jInput.value.trim();
            const sYear = document.getElementById('startYear').value;
            const eYear = document.getElementById('endYear').value;
            const onlyOA = document.getElementById('onlyOA').checked;
            const onlyFT = document.getElementById('onlyFT').checked;

            // æ„å»ºæŸ¥è¯¢è¯­å¥
            let queryParts = [];
            if (issn) queryParts.push(`ISSN:"${issn}"`);
            else if (jName) queryParts.push(`JOURNAL:"${jName}"`);

            if (keyword) queryParts.push(`"${keyword}"`);
            if (sYear && eYear) queryParts.push(`(PUB_YEAR:[${sYear} TO ${eYear}])`);
            if (onlyOA) queryParts.push(`(OPEN_ACCESS:Y)`);
            if (onlyFT) queryParts.push(`(HAS_FT:Y)`);

            const finalQuery = queryParts.join(" AND ");
            if (!finalQuery) {
                showError("è¯·è¾“å…¥å…³é”®è¯æˆ–é€‰æ‹©ä¸€ä¸ªæœŸåˆŠã€‚");
                return;
            }

            setLoading(true);

            try {
                // A. æ‰§è¡Œç»Ÿè®¡ï¼ˆè·å– Total, OA, FT çš„æ•°é‡ï¼‰
                // æ³¨æ„ï¼špageSize å¿…é¡» >= 1ï¼Œå¦åˆ™APIè¿”å›404
                const [statRes, oaRes, ftRes] = await Promise.all([
                    fetch(`${API_BASE}/search?query=${encodeURIComponent(finalQuery)}&pageSize=1&format=json`),
                    fetch(`${API_BASE}/search?query=${encodeURIComponent(finalQuery + " AND (OPEN_ACCESS:Y)")}&pageSize=1&format=json`),
                    fetch(`${API_BASE}/search?query=${encodeURIComponent(finalQuery + " AND (HAS_FT:Y)")}&pageSize=1&format=json`)
                ]);

                const statData = await statRes.json();
                const oaData = await oaRes.json();
                const ftData = await ftRes.json();

                // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯å“åº”
                if (statData.errCode) {
                    throw new Error(statData.errMsg || 'APIè¿”å›é”™è¯¯');
                }

                document.getElementById('statsPanel').classList.remove('d-none');
                document.getElementById('statTotal').innerText = (statData.hitCount || 0).toLocaleString();
                document.getElementById('statOA').innerText = (oaData.hitCount || 0).toLocaleString();
                document.getElementById('statFT').innerText = (ftData.hitCount || 0).toLocaleString();

                // B. è·å–æ–‡ç« åˆ—è¡¨
                const listRes = await fetch(`${API_BASE}/search?query=${encodeURIComponent(finalQuery)}&cursorMark=${cursorMark}&pageSize=10&resultType=lite&format=json`);
                const listData = await listRes.json();

                if (listData.errCode) {
                    throw new Error(listData.errMsg || 'APIè¿”å›é”™è¯¯');
                }

                const results = listData.resultList?.result || [];
                displayResults(results);
                cursorMark = listData.nextCursorMark;
                document.getElementById('loadMore').classList.toggle('d-none', results.length === 0);

            } catch (err) {
                showError("æ— æ³•è¿æ¥åˆ° Europe PMC APIã€‚åŸå› å¯èƒ½æ˜¯ï¼šç½‘ç»œæ–­å¼€ã€è·¨åŸŸé™åˆ¶æˆ–è¯·æ±‚è¿‡äºé¢‘ç¹ã€‚å…·ä½“é”™è¯¯ï¼š" + err.message);
            } finally {
                setLoading(false);
            }
        }

        function displayResults(articles) {
            const container = document.getElementById('resultsList');
            if (!articles || articles.length === 0) {
                if (cursorMark === "*") container.innerHTML = '<div class="alert alert-warning">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡ç« ã€‚</div>';
                return;
            }

            articles.forEach(a => {
                const card = document.createElement('div');
                card.className = "card result-card p-3 shadow-sm";
                card.innerHTML = `
                <div class="d-flex justify-content-between">
                    <h5 class="text-primary">${a.title || 'æ— æ ‡é¢˜'}</h5>
                    <span class="badge bg-secondary">${a.pubYear || 'N/A'}</span>
                </div>
                <div class="text-muted mb-2">${a.journalTitle || 'æœªçŸ¥æœŸåˆŠ'} | ${a.authorString || 'æœªçŸ¥ä½œè€…'}</div>
                <div>
                    ${a.isOpenAccess === 'Y' ? '<span class="badge bg-success">OA</span>' : ''}
                    ${a.inEPMC === 'Y' ? '<span class="badge bg-info">Full Text Available</span>' : ''}
                    ${a.doi ? `<a href="https://doi.org/${a.doi}" target="_blank" class="ms-3 btn btn-sm btn-outline-dark">DOI: ${a.doi}</a>` : ''}
                </div>
            `;
                container.appendChild(card);
            });
        }

        function setLoading(isLoading) {
            document.getElementById('searchBtn').disabled = isLoading;
            document.getElementById('btnSpinner').style.display = isLoading ? 'inline-block' : 'none';
        }

        function showError(msg) {
            const errDiv = document.getElementById('errorAlert');
            errDiv.innerText = msg;
            errDiv.classList.remove('d-none');
        }

        document.getElementById('loadMore').onclick = performSearch;

    </script>
</body>

</html>